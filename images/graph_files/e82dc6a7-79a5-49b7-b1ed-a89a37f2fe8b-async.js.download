/*! permutive-javascript-sdk v5.13.8 (web) (built 2019-01-18 10:43:58 UTC) */
!function(){function lzWorkerFunction(){var e=this;e.compress=function(e){if(null==e)return"";var t,n,r,i={},a={},s="",o="",c="",u=2,l=3,d=2,p=[],f=0,m=0,g=String.fromCharCode,v=function(e){return g(e+32)};for(r=0;r<e.length;r+=1)if(s=e.charAt(r),Object.prototype.hasOwnProperty.call(i,s)||(i[s]=l++,a[s]=!0),o=c+s,Object.prototype.hasOwnProperty.call(i,o))c=o;else{if(Object.prototype.hasOwnProperty.call(a,c)){if(c.charCodeAt(0)<256){for(t=0;t<d;t++)f<<=1,14===m?(m=0,p.push(v(f)),f=0):m++;for(n=c.charCodeAt(0),t=0;t<8;t++)f=f<<1|1&n,14===m?(m=0,p.push(v(f)),f=0):m++,n>>=1}else{for(n=1,t=0;t<d;t++)f=f<<1|n,14===m?(m=0,p.push(v(f)),f=0):m++,n=0;for(n=c.charCodeAt(0),t=0;t<16;t++)f=f<<1|1&n,14===m?(m=0,p.push(v(f)),f=0):m++,n>>=1}0===--u&&(u=Math.pow(2,d),d++),delete a[c]}else for(n=i[c],t=0;t<d;t++)f=f<<1|1&n,14===m?(m=0,p.push(v(f)),f=0):m++,n>>=1;0===--u&&(u=Math.pow(2,d),d++),i[o]=l++,c=String(s)}if(""!==c){if(Object.prototype.hasOwnProperty.call(a,c)){if(c.charCodeAt(0)<256){for(t=0;t<d;t++)f<<=1,14===m?(m=0,p.push(v(f)),f=0):m++;for(n=c.charCodeAt(0),t=0;t<8;t++)f=f<<1|1&n,14===m?(m=0,p.push(v(f)),f=0):m++,n>>=1}else{for(n=1,t=0;t<d;t++)f=f<<1|n,14===m?(m=0,p.push(v(f)),f=0):m++,n=0;for(n=c.charCodeAt(0),t=0;t<16;t++)f=f<<1|1&n,14===m?(m=0,p.push(v(f)),f=0):m++,n>>=1}0===--u&&(u=Math.pow(2,d),d++),delete a[c]}else for(n=i[c],t=0;t<d;t++)f=f<<1|1&n,14===m?(m=0,p.push(v(f)),f=0):m++,n>>=1;0===--u&&(u=Math.pow(2,d),d++)}for(n=2,t=0;t<d;t++)f=f<<1|1&n,14===m?(m=0,p.push(v(f)),f=0):m++,n>>=1;for(;;){if(f<<=1,14===m){p.push(v(f));break}m++}return p.join("")+" "},e.decompress=function(e){if(null==e)return"";if(""===e)return null;var t,n,r,i,a,s,o,c=e.length,u=function(t){return e.charCodeAt(t)-32},l=[],d=4,p=4,f=3,m="",g=[],v={val:u(0),position:16384,index:1},h=String.fromCharCode;for(t=0;t<3;t+=1)l[t]=t;for(r=0,a=Math.pow(2,2),s=1;s!==a;)i=v.val&v.position,v.position>>=1,0===v.position&&(v.position=16384,v.val=u(v.index++)),r|=(i>0?1:0)*s,s<<=1;switch(r){case 0:for(r=0,a=Math.pow(2,8),s=1;s!==a;)i=v.val&v.position,v.position>>=1,0===v.position&&(v.position=16384,v.val=u(v.index++)),r|=(i>0?1:0)*s,s<<=1;o=h(r);break;case 1:for(r=0,a=Math.pow(2,16),s=1;s!==a;)i=v.val&v.position,v.position>>=1,0===v.position&&(v.position=16384,v.val=u(v.index++)),r|=(i>0?1:0)*s,s<<=1;o=h(r);break;case 2:return""}for(l[3]=o,n=o,g.push(o);;){if(v.index>c)return"";for(r=0,a=Math.pow(2,f),s=1;s!==a;)i=v.val&v.position,v.position>>=1,0===v.position&&(v.position=16384,v.val=u(v.index++)),r|=(i>0?1:0)*s,s<<=1;switch(o=r){case 0:for(r=0,a=Math.pow(2,8),s=1;s!==a;)i=v.val&v.position,v.position>>=1,0===v.position&&(v.position=16384,v.val=u(v.index++)),r|=(i>0?1:0)*s,s<<=1;l[p++]=h(r),o=p-1,d--;break;case 1:for(r=0,a=Math.pow(2,16),s=1;s!==a;)i=v.val&v.position,v.position>>=1,0===v.position&&(v.position=16384,v.val=u(v.index++)),r|=(i>0?1:0)*s,s<<=1;l[p++]=h(r),o=p-1,d--;break;case 2:return g.join("")}if(0===d&&(d=Math.pow(2,f),f++),l[o])m=l[o];else{if(o!==p)return null;m=n+n.charAt(0)}g.push(m),l[p++]=n+m.charAt(0),n=m,0===--d&&(d=Math.pow(2,f),f++)}},e.onmessage=function(t){"compress"===t.data.type?e.postMessage({type:"compressed",result:e.compress(t.data.value)}):"decompress"===t.data.type&&e.postMessage({type:"decompressed",result:e.decompress(t.data.value)})}}function extractDomain(e){var t=e.match(/\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b/),n=e.match(/[a-z0-9][a-z0-9\-]+\.[a-z\.]{2,24}$/i),r=e.match(/localhost/);if(n&&n.length>0){var i=e.split(".").reverse();return i.length>=3&&i[1].match(/^(com|edu|gov|net|mil|org|nom|co|ac|name|info|biz)$/i)?i[2]+"."+i[1]+"."+i[0]:i[1]+"."+i[0]}if(t&&t.length>0)return t[0];if(r&&r.length>0)return"localhost";throw"No domain can be found for cookies"}function initialiseSDK(){function makeSafe(e){return function(){try{return e.apply(this,arguments)}catch(e){_internals.error(e)}}}function QueryWorker(){var e=this,t=function(){var e=this&&this.__assign||function(){return(e=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++){t=arguments[n];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e}).apply(this,arguments)},t={k:function(e,t){return t.reduce(function(e,t){return e&&e[t]?e[t]:null},e)},kf:function(e,t,n){var r=t.reduce(function(e,t){return e&&e[t]?e[t]:null},e);return null===r?null:n(r)},ti:function(e){return e.getTime()},pre:function(e,t){var n=t.slice();return n.unshift(e),n},a0:function(e,t){return e&&t},o0:function(e,t){return e||t},n0:function(e){return!e},t:function(e){return!0},a:function(e,t){return function(n){return e(n)&&t(n)}},o:function(e,t){return function(n){return e(n)||t(n)}},i:function(e){return e},as:function(e,n,r){return function(i){return r.reduce(function(r,a){return r&&e(a)(t.k(i,t.pre("properties",n)))},!0)}},os:function(e,n,r){return function(i){return r.reduce(function(r,a){return r||e(a)(t.k(i,t.pre("properties",n)))},!1)}},e:function(e){return function(t){return t===e}},n:function(e){return function(t){return t!==e}},g:function(e){return function(t){return t>e}},ge:function(e){return function(t){return t>=e}},l:function(e){return function(t){return t<e}},le:function(e){return function(t){return t<=e}},b:function(e,t){return function(n){return n>=e&&n<=t}},s:function(e){return function(t){return"string"==typeof e&&"string"==typeof t&&t.toLowerCase().indexOf(e.toLowerCase())>-1}},c:function(e){return function(t){return null!=t&&"object"==typeof t&&t.indexOf(e)>=0}},e_:function(e,n){return function(r){return t.k(r,e)===n}},n_:function(e,n){return function(r){return t.k(r,e)!==n}},g_:function(e,n){return function(r){return t.k(r,e)>n}},ge_:function(e,n){return function(r){return t.k(r,e)>=n}},l_:function(e,n){return function(r){return t.k(r,e)<n}},le_:function(e,n){return function(r){return t.k(r,e)<=n}},b_:function(e,n,r){return function(i){return t.k(i,e)>=n&&t.k(i,e)<=r}},s_:function(e,n){return function(r){var i=t.k(r,e);return"string"==typeof n&&"string"==typeof i&&i.toLowerCase().indexOf(n.toLowerCase())>-1}},c_:function(e,n){return function(r){var i=t.k(r,e);return null!=i&&"object"==typeof i&&i.indexOf(n)>=0}},pe:function(e,n){return function(r){return t.k(r,t.pre("properties",e))===n}},pn:function(e,n){return function(r){return t.k(r,t.pre("properties",e))!==n}},pg:function(e,n){return function(r){return t.k(r,t.pre("properties",e))>n}},pge:function(e,n){return function(r){return t.k(r,t.pre("properties",e))>=n}},pl:function(e,n){return function(r){return t.k(r,t.pre("properties",e))<n}},ple:function(e,n){return function(r){return t.k(r,t.pre("properties",e))<=n}},pb:function(e,n,r){return function(i){return t.k(i,t.pre("properties",e))>=n&&t.k(i,t.pre("properties",e))<=r}},ps:function(e,n){return function(r){var i=t.k(r,t.pre("properties",e));return"string"==typeof n&&"string"==typeof i&&i.toLowerCase().indexOf(n.toLowerCase())>-1}},pc:function(e,n){return function(r){var i=t.k(r,t.pre("properties",e));return null!=i&&"object"==typeof i&&i.indexOf(n)>=0}},te_:function(e,n){return function(r){return t.kf(r,e,t.ti)===n}},tn_:function(e,n){return function(r){return t.kf(r,e,t.ti)!==n}},tg_:function(e,n){return function(r){return t.kf(r,e,t.ti)>n}},tge_:function(e,n){return function(r){return t.kf(r,e,t.ti)>=n}},tl_:function(e,n){return function(r){return t.kf(r,e,t.ti)<n}},tle_:function(e,n){return function(r){return t.kf(r,e,t.ti)<=n}},tb_:function(e,n,r){return function(i){return t.kf(i,e,t.ti)>=n&&t.kf(i,e,t.ti)<=r}},te:function(e){return function(n){return t.kf(n,["time"],t.ti)===e}},tn:function(e){return function(n){return t.kf(n,["time"],t.ti)!==e}},tg:function(e){return function(n){return t.kf(n,["time"],t.ti)>e}},tge:function(e){return function(n){return t.kf(n,["time"],t.ti)>=e}},tl:function(e){return function(n){return t.kf(n,["time"],t.ti)<e}},tle:function(e){return function(n){return t.kf(n,["time"],t.ti)<=e}},tb:function(e,n){return function(r){return t.kf(r,["time"],t.ti)>=e&&t.kf(r,["time"],t.ti)<=n}},tp:function(e,n,r,i,a){var s=t.k(e.getSegments(),[n,r])||!1;return a&&(i||s)&&e.setThirdPartyActivation(n,r,a),s},sp:function(e,n,r,i,a){var s=t.k(e.getSegments(),[n,r])||!1;return a&&(i||s)&&e.setSegmentActivation(n,r,a),s},oe:function(e){for(var t=Object.keys(e),n=t.length,r=new Array(n);n--;)r[n]=[t[n],e[t[n]]];return r},lms:function(e,n,r){var i=e||{},a=n[r]||{},s=(a["1p"]||{}).const||0,o=t.oe(a);for(var c in o){var u=t.oe(o[c][1]);for(var l in u)!0===(i[o[c][0]]||{})[u[l][0]]&&(s+=u[l][1])}return function(e){return 1/(1+Math.pow(Math.E,-e))}(s)},fm:function(e,t){return{p:t.p,r:function(n,r){return e(t.r(n,r))},a:t.a}},cq:function(e,t,n){return{p:function(e,r){return[t.p(e,r),n.p(e,r)]},r:function(r,i){return e(t.r(r,i[0]),n.r(r,i[1]))},a:{z:[t.a.z,n.a.z],m:function(e,r){return[t.a.m(e[0],r[0]),n.a.m(e[1],r[1])]}}}},cw:function(e,n,r){return void 0===r&&(r=t.i),{a:{m:function(e,t){return e+t},z:0},p:function(r,i){return t.k(i,["name"])===e&&n(i)?1:0},r:function(e,t){return r(t)}}},mxw:function(e,n,r,i){void 0===i&&(i=t.i);var a=Number.NEGATIVE_INFINITY;return{a:{m:function(e,t){return e>t?e:t},z:a},p:function(i,s){return t.k(s,["name"])===e&&n(s)?t.k(s,r):a},r:function(e,t){return i(t)}}},vgw:function(e,n,r,i){void 0===i&&(i=t.i);var a={v:0,k:0};return{a:{m:function(e,t){var n=e.k+t.k;return{v:n?e.v+t.k*(t.v-e.v)/n:0,k:n}},z:a},p:function(i,s){return t.k(s,["name"])===e&&n(s)?{v:t.k(s,r),k:1}:a},r:function(e,t){return i(t.v)}}},mnw:function(e,n,r,i){void 0===i&&(i=t.i);var a=Number.POSITIVE_INFINITY;return{a:{m:function(e,t){return e<t?e:t},z:a},p:function(i,s){return t.k(s,["name"])===e&&n(s)?t.k(s,r):a},r:function(e,t){return i(t)}}},sw:function(e,n,r,i){void 0===i&&(i=t.i);return{a:{m:function(e,t){return e+t},z:0},p:function(i,a){return t.k(a,["name"])===e&&n(a)?t.k(a,r):0},r:function(e,t){return i(t)}}},pw:function(e,n,r,i){void 0===i&&(i=t.i);return{a:{m:function(e,t){return e*t},z:1},p:function(i,a){return t.k(a,["name"])===e&&n(a)?t.k(a,r):1},r:function(e,t){return i(t)}}},ctw:function(e,n,r,i){return{a:i?{m:function(e,t){return e.concat(t).slice(-i)},z:[]}:{m:function(e,t){return e.concat(t)},z:[]},p:function(i,a){return t.k(a,["name"])===e&&n(a)?t.k(a,r):[]},r:function(e,t){return t}}},ctv:function(n,r,i,a){function s(e,t){var n=function(e){return{k:e.k,c:1+e.c}},r={arr:[],add:{k:t,c:1}};return t?function(e){return e.arr.concat(e.add)}(e.reduce(function(e,t){return e.add.k===t.k?{arr:e.arr,add:n(t)}:{arr:e.arr.concat(t),add:e.add}},r)):e}return{a:a?{m:function(e,t){return s(e,t).slice(-a)},z:[]}:{m:function(e,t){return s(e,t)},z:[]},p:function(e,a){return t.k(a,["name"])===n&&r(a)?t.k(a,i):null},r:function(t,n){return n.reduce(function(t,n){var r;return e({},t,(r={},r[n.k]=n.c,r))},{})}}},ctu:function(e,n,r,i){return{a:i?{m:function(e,t){return e.filter(function(e){return!t.includes(e)}).concat(t).slice(-i)},z:[]}:{m:function(e,t){return e.filter(function(e){return!t.includes(e)}).concat(t)},z:[]},p:function(i,a){return t.k(a,["name"])===e&&n(a)?t.k(a,r):[]},r:function(e,t){return t}}},itp:function(e,n,r,i){return{a:{m:function(e,t){return t},z:!1},p:function(a,s){return t.tp(a,e,n,r,i)},r:function(e,t){return t}}},isp:function(e,n,r,i){return{a:{m:function(e,t){return t},z:!1},p:function(a,s){return t.sp(a,e,n,r,i)},r:function(e,t){return t}}},ifp:function(e){return{a:{m:function(e,t){return t},z:!1},p:function(n,r){return t.tp(n,"1p",e,!1)},r:function(e,t){return t}}},lm:function(e,n){return{a:{m:function(e,t){return t},z:[]},p:function(n,r){return[t.lms(n.getSegments(),n.getLookalikeModels(),e)]},r:function(e,t){return!!t[0]&&n(t[0])}}},sq:function(e){return{a:{m:function(t,n){return[n[0],e.a.m(null!=t[0]&&t[0][0]===n[0][0]?t[1]:e.a.z,n[1])]},z:[[],e.a.z]},p:function(n,r){return[[n.getCurrentSession()],t.k(r,["session_id"])===n.getCurrentSession()?e.p(n,r):e.a.z]},r:function(t,n){return e.r(t,n[0]!=[]&&n[0][0]===t.getCurrentSession()?n[1]:e.a.z)}}},vq:function(e){return{a:{m:function(t,n){return[n[0],e.a.m(null!=t[0]&&t[0][0]===n[0][0]?t[1]:e.a.z,n[1])]},z:[[],e.a.z]},p:function(n,r){return[[n.getCurrentView()],t.k(r,["view_id"])===n.getCurrentView()?e.p(n,r):e.a.z]},r:function(t,n){return e.r(t,n[0]!=[]&&n[0][0]===t.getCurrentView()?n[1]:e.a.z)}}},ltn:function(e,t){return{a:{m:function(e,n){return e.concat(n).slice(-t)},z:[]},p:function(t,n){return[e.p(t,n)]},r:function(t,n){return e.r(t,n.reduce(function(t,n){return e.a.m(t,n)},e.a.z))}}},ftn:function(e,t){return{a:{m:function(e,n){return e.concat(n.slice(0,t-e.length))},z:[]},p:function(t,n){return[e.p(t,n)]},r:function(t,n){return e.r(t,n.reduce(function(t,n){return e.a.m(t,n)},e.a.z))}}},tw:function(e,r){return{a:{m:function(t,r){return n.compose(e.a,t,r)},z:n.init({w:r})},p:function(i,a){return n.init({w:r,t:Math.max(t.kf(a,["time"],function(e){return e.getTime()}),i.getCurrentTime()),v:e.p(i,a)})},r:function(t,r){return e.r(t,n.query(e.a,r))}}},q:function(e){return{initial:function(t){return{result:e.a.z}},update:function(t,n,r){return{result:e.a.m(n.result,e.p(t,r))}},result:function(t,n){return{result:e.r(t,n.result)}},m:e.a.m,z:e.a.z,p:e.p,r:e.r}}},n={init:function(e){var t=e.t||Number.MIN_SAFE_INTEGER;return{w:e.w,t:t,in:void 0!==e.v?[[e.v,e.v,t]]:e.in||[],out:e.out||[]}},aIn:function(e,t){return t.in.length?t.in[t.in.length-1][1]:e.z},aOut:function(e,t){return t.out.length?t.out[t.out.length-1][1]:e.z},aOut_:function(e,t){return t.length?t[t.length-1][1]:e.z},query:function(e,t){return e.m(n.aOut(e,t),n.aIn(e,t))},enqueue:function(e,t,r,i){if(i<t.t)return t;var a=t.in.slice();return a.push([r,e.m(n.aIn(e,t),r),i]),n.init({w:t.w,t:i,in:a,out:t.out.slice()})},dequeue:function(e,t){var r=t.out.slice(),i=t.in.slice();if(!t.out.length)for(;i.length;){var a=i[i.length-1];r.push([a[0],e.m(a[0],n.aOut_(e,r)),a[2]]),i.pop()}return r.pop(),n.init({w:t.w,t:t.t,in:i,out:r})},minTime:function(e){return e.out.length?e.out[e.out.length-1][2]:e.in.length?e.in[0][2]:Number.MAX_SAFE_INTEGER},compose:function(e,t,r){if(r.t<t.t||t.w!==r.w)return t;for(var i=[],a=r.out.length-1;a>=0;--a)i.push([r.out[a][0],r.out[a][2]]);for(a=0;a<r.in.length;++a)i.push([r.in[a][0],r.in[a][2]]);for(var s=n.init({w:t.w,t:t.t,in:t.in.slice(),out:t.out.slice()}),a=0;a<i.length;++a)i[a][0]!==e.z&&(s=n.enqueue(e,s,i[a][0],i[a][1]));for(var o=r.t-r.w;n.minTime(s)<=o;)s=n.dequeue(e,s);return s}},r={2482:t.q(t.cq(t.a0,t.cw("Pageview",t.ps(["client","title"],"security"),t.ge(1)),t.cw("PageviewEngagement",t.t,t.ge(12)))),2491:t.q(t.cw("Pageview",t.t,t.ge(1))),2492:t.q(t.tw(t.cw("Pageview",t.t,t.ge(3)),2592e6)),2493:t.q(t.tw(t.cw("Pageview",t.t,t.ge(5)),2592e6)),2494:t.q(t.tw(t.cw("PageviewEngagement",t.t,t.ge(6)),2592e6)),2495:t.q(t.tw(t.cw("PageviewEngagement",t.t,t.ge(12)),2592e6)),2584:t.q(t.tw(t.cw("Pageview",t.a(t.ps(["client","url"],"politic"),t.ps(["client","domain"],"newstatesman")),t.ge(3)),24192e5)),2631:t.q(t.tw(t.cw("Pageview",t.ps(["client","url"],"business"),t.ge(3)),6048e5)),2637:t.q(t.cq(t.o0,t.cw("Pageview",t.o(t.ps(["client","referrer"],"newstatesman.com/long-reads"),t.ps(["client","url"],"newstatesman.com/long-reads")),t.ge(1)),t.cw("LinkClick",t.ps(["client","referrer"],"newstatesman.com/long-reads"),t.ge(1)))),2646:t.q(t.cw("Pageview",t.ps(["client","domain"],"elitetraveler"),t.ge(1))),2647:t.q(t.cq(t.a0,t.cw("Pageview",t.ps(["client","url"],"luxury-transport"),t.ge(1)),t.cw("SegmentEntry",t.pe(["segment_name"],"EliteTraveler"),t.ge(1)))),2648:t.q(t.cq(t.a0,t.cw("Pageview",t.ps(["client","url"],"hotels-resorts-spas"),t.ge(1)),t.cw("SegmentEntry",t.pe(["segment_name"],"EliteTraveler"),t.ge(1)))),2650:t.q(t.sq(t.cw("Pageview",t.ps(["client","url"],"utm_medium=social"),t.ge(1)))),2651:t.q(t.cq(t.a0,t.sq(t.cw("Pageview",t.ps(["client","url"],"utm_source=facebook.com"),t.ge(1))),t.cw("SegmentEntry",t.pe(["segment_name"],"Social Traffic"),t.ge(1)))),2652:t.q(t.cq(t.a0,t.sq(t.cw("Pageview",t.ps(["client","url"],"utm_source=twitter.com"),t.ge(1))),t.cw("SegmentEntry",t.pe(["segment_name"],"Social Traffic"),t.ge(1)))),2655:t.q(t.sq(t.cw("Pageview",t.ps(["client","url"],"utm_medium=email"),t.ge(1))))};return void 0!==r?r:{}}(),n={2482:["cd8a557a80","Interests: Security",["s"],"a5eb161c-950c-4a34-8818-b76e9d9efb9f"],2491:["0c8b70cdb7","Everyone",["s"],"25d061af-a299-4395-91d1-52a2a8aa109f"],2492:["8d661148fc","Engaged_Pageviews_3+_30Days",["s"],"6de40117-6867-4dd2-b66a-0761b9c34dc1"],2493:["25b32e17c9","Engaged_Pageviews_5+_30Days",["s"],"d09aff6a-78a9-4c4b-a403-d2b56a43c02f"],2494:["264c633123","Engaged_Time_30s+_30Days",["s"],"8ff37adc-bfe3-45bf-bb84-a397f505e8b8"],2495:["e957fe1564","Engaged_Time_60s+_30Days",["s"],"61543bc3-8d72-43e6-8688-63a1fbc2b4b3"],2584:["393d79089f","Interest_Politics_NewStatesman",["s"],"68ff61ca-2244-4866-8a18-dd3e00494b6e"],2631:["2cd8286807","High Engaged Business Interest",["s"],"10271e10-a4fe-46a3-8892-e9a68ee91966"],2637:["d407ccfecd","NewStatesman_long-read-enthusiasts",["s"],"5a7235d9-5a9e-4fff-a5db-aec0863e4597"],2646:["94f56a3e12","EliteTraveler",["s"],"e433e384-842e-4272-88dc-867eb6a7b1e3"],2647:["0df21e2257","EliteTraveler_Luxury Transport",["s"],"a1ce530d-c6f0-4f3b-a4d0-35f7f07c3614"],2648:["1ffeca7dfe","EliteTraveler_Hotels Resorts & Spas",["s"],"1b88b39b-4be7-4d2e-8f44-3f4f62423db9"],2650:["1dc20f17e5","Social Traffic",["s"],"05163b1d-03de-4f93-b61d-e1f650cf944d"],2651:["fb28cf11ae","Social Traffic_Facebook",["s"],"a6d84eea-8e80-4479-82e8-abf79fc02281"],2652:["c00e47e45c","Social Traffic_Twitter",["s"],"6dba9647-a73f-4651-8e60-a38bb2de3b42"],2655:["5c15004e9b","Email Traffic",["s"],"4e445742-b2c3-43cf-831e-6efdfc0b6c3f"]},r=null,i=!1,a=[],s={},o=function(t){switch(t.type){case"init":return e.init(t.msgId,t.args[0],t.args[1],t.args[2]);case"processEvents":return e.processEvents(t.msgId,t.args[0]);case"updateEnvironment":return e.updateEnvironment(t.msgId,t.args[0]);default:throw Error("Unexpected message "+t)}},c=function(t){e.postMessage({type:"complete",args:t})},u=function(t){0!==Object.keys(t).length&&e.postMessage({type:"stateChange",args:t})},l=function(t){0!==t.length&&e.postMessage({type:"errors",args:t})},d=function(e,n,d){var p={},f=[];n.forEach(function(e){var n=t[e],i=s[e];d.forEach(function(t){try{i.state=n.update(r,i.state,t)}catch(n){f.push({error:n.toString(),identifier:e,event_id:t.id})}}),i.result=n.result(r,i.state),p[e]=s[e]}),u(p),l(f),i=!0,a.forEach(o),a=[],c(e)};this.init=function(e,i,a,o){var c=a.lookalikeModels||{},u=function(e,t,n){var r=s[n].activations;e in r?-1!==r[e].indexOf(t)||r[e].push(t):r[e]=[t]};s=i,r={getCurrentTime:function(){return new Date},getCurrentSession:function(){return a.sessionId},getCurrentView:function(){return a.viewId},getSegments:function(){return a.segments},getLookalikeModels:function(){return c},setThirdPartyActivation:u,setSegmentActivation:u};var l=[];Object.keys(n).forEach(function(e){var a=n[e];if(!(e in i)||i[e].checksum!==a[0]){l.push(parseInt(e));var o=t[e],c=o.initial(r);s[e]={name:a[1],id:a[3],is_segment:a[2].indexOf("s")>-1,is_cloud:a[2].indexOf("c")>-1,checksum:a[0],state:c,result:o.result(r,c),activations:{}}}}),d(e,l,o)},this.updateEnvironment=function(t,n){if(!i)return a.push({msgId:t,type:"updateEnvironment",args:[n]});n.sessionId&&(r.getCurrentSession=function(){return n.sessionId}),n.segments&&(r.getSegments=function(){return n.segments}),n.lookalikeModels&&(r.getLookalikeModels=function(){return n.lookalikeModels}),e.processEvents(t,[{}])},this.processEvents=function(e,o){if(!i)return a.push({msgId:e,type:"processEvents",args:[o]});var d={},p=[];o.forEach(function(e){Object.keys(n).forEach(function(n){var i=t[n],a=s[n].state;try{var o=i.update(r,a,e);JSON.stringify(a)!==JSON.stringify(o)&&(s[n].state=o,s[n].result=i.result(r,o),d[n]=s[n])}catch(t){p.push({error:t.toString(),identifier:n,event_id:e.id})}})}),u(d),l(p),c(e)},onmessage=function(e){o(e.data)}}function isEntryOrExit(e){return"SegmentEntry"===e.name||"SegmentExit"===e.name}function transitionToState(e){return"SegmentEntry"===e.name}function isTrackError(e){return void 0!==e.request_id}_internals.addons={},_internals.promises=new PermutivePromises;var Events=function(e){var t={},n=[];(e=e||this).on=function(n,r,i){return(t[n]=t[n]||[]).push([r,i]),e},e.off=function(r,i){r||(t={});for(var a=t[r]||n,s=a.length=i?a.length:0;s--;)i==a[s][0]&&a.splice(s,1);return e},e.once=function(t,r){var i=n.slice.call(arguments,2),a=function(){r(i),e.off(t,a)};return e.on(t,a),e},e.emit=function(r){for(var i,a=t[r]||n,s=a.length>0?a.slice(0,a.length):a,o=0;i=s[o++];)i[0].apply(i[1],n.slice.call(arguments,1));return e}};_internals.messages=new Events;var PermutiveMessages,EVENTS_CACHE_KEY="permutive-events-lz",EVENTS_CACHE_NO_LZ_KEY="permutive-events-cache",PermutiveEventsCache=function(){function e(e){this.state=e,this.initialised=!1,this.hasAttemptedSizeReduction=!1,this.eventObjectCache=[],this.lastRefreshed=null,this.limit=2500,this.retrieveLastRefreshTime()}return e.prototype.all=function(){return this.eventObjectCache},e.prototype.setReady=function(){this.initialised=!0,_internals.messages.emit("permutive:events:cache:loaded")},e.prototype.add=function(e,t){void 0===t&&(t={shouldWrite:!0});for(var n=!1,r=0;r<this.eventObjectCache.length;r++)if(this.eventObjectCache[r].id===e.id){n=!0;break}if(n)e=void 0;else{for(;-1!==this.limit&&this.eventObjectCache.length>=this.limit;)this.eventObjectCache.shift();this.eventObjectCache.push(e),t.shouldWrite&&this.write()}return e},e.prototype.processCachedEvents=function(e){for(var t=[],n=0;n<e.length;n++){var r=this.createEvent(e[n]);t.push(r),this.add(r,{shouldWrite:!1})}return t},e.prototype.load=function(){var e=PermutiveUtils.deferredPromise();_internals.metrics.startTimer("sdk_load_events_cache_task_duration_seconds",{});var t=function(){var e=_internals.getExternalData(EVENTS_CACHE_NO_LZ_KEY);return e?(_internals.log("Migrating uncompressed events..."),LZWorker.compress(JSON.stringify(e),function(e){_internals.setExternalData(EVENTS_CACHE_KEY,e.result)}),_internals.removeExternalData(EVENTS_CACHE_NO_LZ_KEY),e):null}();if(t)e.resolve(JSON.parse(t));else{var n=_internals.getExternalData(EVENTS_CACHE_KEY);n?LZWorker.decompress(n,function(t){e.resolve(t.result?JSON.parse(t.result):[])}):e.resolve([])}return e.promise.then(function(){_internals.metrics.stopTimer("sdk_load_events_cache_task_duration_seconds",{})}),e.promise},e.prototype.refresh=function(e){return void 0===e&&(e={processImmediately:!1}),e.from||(e.from=this.getRefreshFromTime(),this.lastRefreshed=e.from,this.storeLastRefreshTime()),_internals.log("refreshing from: ",e.from),_internals.api.events(_internals.state.userId,{error:e.error,complete:e.complete,from:e.from})},e.prototype.processRefreshEvents=function(e,t){void 0===t&&(t={});for(var n=[],r=e||[],i=0;i<r.length;i++){var a=this.add(this.createEvent(r[i]),{shouldWrite:!1});a&&n.push(a)}if(r.length>0){var s=new Date(r[r.length-1].time);s.setMilliseconds(s.getMilliseconds()+1),this.lastRefreshed=s,this.storeLastRefreshTime()}return _internals.log("events from api: ",r),_internals.log("new events from api: ",n),_internals.log("events cache",this.eventObjectCache),n.length>0&&t.write&&this.write(),n},e.prototype.reset=function(){_internals.removeExternalData(EVENTS_CACHE_KEY),this.eventObjectCache=[],this.lastRefreshed=null},e.prototype.createEvent=function(e){var t={id:e.id,name:e.name,time:new Date(e.time),properties:this.parseProperties(e.properties||{})};return e.session_id&&(t.session_id=e.session_id),e.view_id&&(t.view_id=e.view_id),t},e.prototype.write=function(e){var t=this;if(this.initialised){var n=this;_internals.log("Writing cache (#e)",this.eventObjectCache.length),LZWorker.compress(JSON.stringify(this.eventObjectCache),function(t){try{_internals.setExternalData(EVENTS_CACHE_KEY,t.result),"function"==typeof e&&e()}catch(t){if(t.message="Unable to write events to local storage: "+t.message,_internals.error(t),void 0!==t.message&&t.message.toString().toLowerCase().indexOf("quota")>-1&&!n.hasAttemptedSizeReduction){_internals.log("reducing cache size by 10%, due to local storage limit reached");for(var r=n.eventObjectCache.length;n.eventObjectCache.length>.9*r;)n.eventObjectCache.shift();n.hasAttemptedSizeReduction=!0,n.write()}}})}else _internals.messages.on("permutive:events:cache:loaded",function(){t.write(e)})},e.prototype.setRefreshFromTime=function(e){this.lastRefreshed=e,this.storeLastRefreshTime()},e.prototype.getRefreshFromTime=function(){var e=this.lastRefreshed;return e||(e=_internals.utcNow()),e&&e.setMilliseconds(e.getMilliseconds()+1),e},e.prototype.storeLastRefreshTime=function(){this.state.setPermutiveData("last_refresh_time",this.lastRefreshed.toISOString())},e.prototype.retrieveLastRefreshTime=function(){var e=this.state.getPermutiveData("last_refresh_time")||null;e&&(this.lastRefreshed=new Date(e))},e.prototype.parseProperties=function(e){var t={};for(var n in e)if(e.hasOwnProperty(n)){var r=e[n],i=r;"string"==typeof r&&r.match(ISO8601_REGEX)&&(i=new Date(r)),t[n]=i}return t},e}(),CACHED_SEGMENTS_STORAGE_KEY="_psegs",QueryManager=function(){function e(e){var t=this;this.state=e,this.initialised=!1,this.stateChangeQueue=[],this.userSegments=[],this.userSegmentsDict={},this.queryStateMap={},this.globalMsgId=0,this.resolves={},this.readSegmentCache(),this.readQueryStateCache(),this.handlers={complete:function(e){var n=t.resolves[e];n&&n(),delete t.resolves[e]},errors:function(e){e.forEach(function(e){_internals.error("QL error. "+e.error+" in query "+e.identifier+" with event "+e.event_id)})},stateChange:function(e){if(!t.initialised)return t.stateChangeQueue.push(e);for(var n in e)if(e.hasOwnProperty(n)){var r=parseInt(n),i=e[r];if(i.is_segment){var a=r in t.userSegmentsDict,s=i.result.result;if(a===s)continue;s?t.addSegment(r):t.removeSegment(r),t.trackSegmentTransition(s,i.id,r,i.name)}else{var o=t.queryStateMap[r]||{result:{}};if(JSON.stringify(o.result)===JSON.stringify(i.result))continue}_internals.messages.emit("permutive:query:changed",{queryCode:r,result:i.result})}Object.keys(e).length>0&&(t.queryStateMap=PermutiveUtils.merge(t.queryStateMap,e),t.writeSegmentCache(),t.writeQueryStateCache()),_internals.messages.emit("permutive:segments:updated")}};var n=new Blob([("("+QueryWorker+")();").replace('"use strict";',"")],{type:"application/javascript"});this.worker=new Worker(URL.createObjectURL(n)),this.worker.onmessage=function(e){switch(e.data.type){case"stateChange":return t.handlers.stateChange(e.data.args);case"errors":return t.handlers.errors(e.data.args);case"complete":return t.handlers.complete(e.data.args)}},this.worker.onerror=function(e){e.preventDefault(),_internals.error("WebWorker error: "+e.message)}}return e.prototype.initWorker=function(e){return this.sendMessage({type:"init",args:[this.queryStateMap,{segments:{"1p":this.userSegmentsDict},sessionId:_internals.sessionManager.getSessionId(),viewId:_internals.state.getViewId(),lookalikeModels:{}},e]})},e.prototype.updateEnvironment=function(e){return this.sendMessage({type:"updateEnvironment",args:[e]})},e.prototype.updateWithHistoricSegments=function(e){return 0===e.length?Promise.resolve():(this.updateSegmentResults(e),this.sendMessage({type:"processEvents",args:[e]}))},e.prototype.update=function(e){var t=this.sendMessage({type:"processEvents",args:[e]});return _internals.isRealtime||t.then(function(){_internals.setAsRealtime()}),t},e.prototype.updateSegmentResults=function(e){var t=this;if(0!==e.length){var n=this.calculateHistoricSegments(e);_internals.log("New segment states",n),Object.keys(n).forEach(function(e){var r=parseInt(e);n[r]?t.addSegment(r):t.removeSegment(r)}),Object.keys(n).length>0&&this.writeSegmentCache()}},e.prototype.handleResult=function(e,t){e in this.queryStateMap&&t(this.queryStateMap[e].result)},e.prototype.getActivations=function(){var e={};for(var t in this.queryStateMap)if(this.queryStateMap.hasOwnProperty(t)){var n=this.queryStateMap[t].activations;for(var r in n)if(this.queryStateMap[t].activations.hasOwnProperty(r))for(var i=this.queryStateMap[t].activations[r],a=0;a<i.length;a++)t in e||(e[t]=[]),e[t].push({segment_id:t,data_provider_id:r,data_provider_segment_id:i[a]})}return e},e.prototype.reset=function(){this.clearSegmentCache(),this.clearQueryStateCache(),this.userSegments=[],this.userSegmentsDict={},this.queryStateMap={}},e.prototype.setAsReady=function(){this.initialised=!0,this.processStateChangeQueue(),_internals.messages.emit("permutive:queries:initialised")},e.prototype.processStateChangeQueue=function(){_internals.log("state change queue",this.stateChangeQueue);var e=this.stateChangeQueue.reduce(function(e,t){return PermutiveUtils.merge(e,t)},{});this.stateChangeQueue=[],_internals.log("final state",e),this.handlers.stateChange(e)},e.prototype.sendMessage=function(e){var t=this,n=this.globalMsgId++;return new Promise(function(r,i){t.resolves[n]=r,e.msgId=n,t.worker.postMessage(e)})},e.prototype.addSegment=function(e){this.userSegmentsDict[e]||(this.userSegments.push(e),this.userSegmentsDict[e]=!0)},e.prototype.removeSegment=function(e){if(e in this.userSegmentsDict){delete this.userSegmentsDict[e];var t=this.userSegments.indexOf(e);t>-1&&this.userSegments.splice(t,1)}},e.prototype.calculateHistoricSegments=function(e){for(var t={},n=0;n<e.length;n++){var r=e[n];isEntryOrExit(r)&&(t[r.properties.segment_number]=transitionToState(r))}return t},e.prototype.trackSegmentTransition=function(e,t,n,r){var i=e?"SegmentEntry":"SegmentExit",a={segment_id:t,segment_number:n,segment_name:r};permutive.track(i,a)},e.prototype.writeSegmentCache=function(){_internals.log("Writing segment cache");var e=JSON.stringify(this.userSegments);_internals.setExternalData(CACHED_SEGMENTS_STORAGE_KEY,e)},e.prototype.readSegmentCache=function(){var e=this,t=localStorage.getItem(CACHED_SEGMENTS_STORAGE_KEY);t&&(this.userSegments=JSON.parse(t),this.userSegments.forEach(function(t){e.userSegmentsDict[t]=!0})),_internals.log("Read segment cache",this.userSegments)},e.prototype.clearSegmentCache=function(){localStorage.removeItem(CACHED_SEGMENTS_STORAGE_KEY)},e.prototype.writeQueryStateCache=function(){_internals.log("Writing query state cache",this.queryStateMap),this.state.setPermutiveData("query_states",this.queryStateMap)},e.prototype.readQueryStateCache=function(){this.queryStateMap=this.state.getPermutiveData("query_states")||{},_internals.log("Read query state cache",this.queryStateMap)},e.prototype.clearQueryStateCache=function(){this.state.setPermutiveData("query_states",{})},e}(),PermutiveReaction=function(){function e(e,t,n,r,i,a,s){this.id=e,this.segmentCode=t,this.segmentName=n,this.reactionType=r,this.triggerType=i,this.variantId=a,this.config=s}return e.prototype.reactEveryTime=function(){return"EveryTime"===this.triggerType},e.prototype.reactOnEntry=function(){return"OnEntry"===this.triggerType},e.prototype.reactOnExit=function(){return"OnExit"===this.triggerType},e.prototype.trackImpression=function(e){var t={reaction_id:this.id,variant_id:this.variantId,type:"impression"};permutive.track("Reaction",t,e),_internals.log("impression: ",t)},e.prototype.trackConversion=function(e){var t={reaction_id:this.id,variant_id:this.variantId,type:"conversion"};permutive.track("Reaction",t,e),_internals.log("conversion: ",t)},e}(),PermutiveReactionManager=function(){function e(e){this.state=e,this.reactionsConfig=[{id:"3953f848-f0fb-4fbf-ba6f-556c1065d461",reaction_type:"run_script",trigger_type:"EveryTime",variants:[{config:{script:"window._pCbCallback = function(response) {\n\tif (response) {\n\t\tvar xhttp = new XMLHttpRequest();\n\t\txhttp.open('POST', '/clearbit', true);\n\t\txhttp.setRequestHeader('Content-Type', 'application/json');\n\t\txhttp.send(JSON.stringify(response));\n\t\tpermutive.track(\"Clearbit\", response);\n\t}\n}\nvar cbs = document.createElement('script');\ncbs.setAttribute('src','https://reveal.clearbit.com/v1/companies/reveal?authorization=pk_bcf6023ac7569a6d92f7af8c606484a1&callback=_pCbCallback&variable=_cbResponse');\ndocument.body.appendChild(cbs);\t"},id:"cf92d853-5a2d-4b80-aeb6-fe5d3584e111",start_bucket:0,context_criteria:{criteria:[{key:"url",value:"carrolltechnologiesgroup.com",comparison:"CONTAINS"}],operator:"OR"},segment_code:2491}]},{id:"398cbbbd-efc1-4f1a-858c-09b2fd3d1db4",reaction_type:"run_script",trigger_type:"EveryTime",variants:[{config:{script:"window._pCbCallback = function(response) {\n\tif (response) {\n\t\tvar xhttp = new XMLHttpRequest();\n\t\txhttp.open('POST', '/clearbit', true);\n\t\txhttp.setRequestHeader('Content-Type', 'application/json');\n\t\txhttp.send(JSON.stringify(response));\n  \t\tpermutive.track(\"Clearbit\", response);\n  \t\tif(window._tgCallback){\n  \t\t\twindow._tgCallback(response)\n\t\t}\n\t}\n}\nvar cbs = document.createElement('script');\ncbs.setAttribute('src','https://reveal.clearbit.com/v1/companies/reveal?authorization=pk_bcf6023ac7569a6d92f7af8c606484a1&callback=_pCbCallback&variable=_cbResponse');\ndocument.body.appendChild(cbs);"},id:"e457a5d5-0289-4732-90c5-c4038d0d5fbb",start_bucket:0,context_criteria:{criteria:[{key:"url",value:"elitetraveler.com",comparison:"CONTAINS"}],operator:"AND"},segment_code:2491}]},{id:"5263186a-c8ab-4956-9b58-9917327420ef",reaction_type:"run_script",trigger_type:"EveryTime",variants:[{config:{script:"window._pCbCallback = function(response) {\n\tif (response) {\n\t\tvar xhttp = new XMLHttpRequest();\n\t\txhttp.open('POST', '/clearbit', true);\n\t\txhttp.setRequestHeader('Content-Type', 'application/json');\n\t\txhttp.send(JSON.stringify(response));\n  \t\tpermutive.track(\"Clearbit\", response);\n  \t\tif(window._tgCallback){\n  \t\t\twindow._tgCallback(response)\n\t\t}\n\t}\n}\nvar cbs = document.createElement('script');\ncbs.setAttribute('src','https://reveal.clearbit.com/v1/companies/reveal?authorization=pk_bcf6023ac7569a6d92f7af8c606484a1&callback=_pCbCallback&variable=_cbResponse');\ndocument.body.appendChild(cbs);"},id:"ac2fb9b2-31e0-4fcb-a978-2d39826528cf",start_bucket:0,context_criteria:{criteria:[{key:"url",value:"spearswms.com",comparison:"CONTAINS"}],operator:"AND"},segment_code:2491}]},{id:"d1e1728b-092e-4ec4-92b2-59d66d008d2f",reaction_type:"run_script",trigger_type:"EveryTime",variants:[{config:{script:"window._pCbCallback = function(response) {\n\tif (response) {\n\t\tvar xhttp = new XMLHttpRequest();\n\t\txhttp.open('POST', '/clearbit', true);\n\t\txhttp.setRequestHeader('Content-Type', 'application/json');\n\t\txhttp.send(JSON.stringify(response));\n  \t\tpermutive.track(\"Clearbit\", response);\n  \t\tif(window._tgCallback){\n  \t\t\twindow._tgCallback(response)\n\t\t}\n\t}\n}\nvar cbs = document.createElement('script');\ncbs.setAttribute('src','https://reveal.clearbit.com/v1/companies/reveal?authorization=pk_bcf6023ac7569a6d92f7af8c606484a1&callback=_pCbCallback&variable=_cbResponse');\ndocument.body.appendChild(cbs);"},id:"5bfe5af7-ed86-427b-bcb7-30a9d9b83d68",start_bucket:0,context_criteria:{criteria:[{key:"url",value:"cbronline.com",comparison:"CONTAINS"},{key:"url",value:"clinicaltrialsarena.com",comparison:"CONTAINS"}],operator:"OR"},segment_code:2491}]},{id:"72731819-a243-49b1-8e2e-271d9aa21c81",reaction_type:"run_script",trigger_type:"EveryTime",variants:[{config:{script:"window._pCbCallback = function(response) {\n\tif (response) {\n\t\tvar xhttp = new XMLHttpRequest();\n\t\txhttp.open('POST', '/clearbit', true);\n\t\txhttp.setRequestHeader('Content-Type', 'application/json');\n\t\txhttp.send(JSON.stringify(response));\n  \t\tpermutive.track(\"Clearbit\", response);\n  \t\tif(window._tgCallback){\n  \t\t\twindow._tgCallback(response)\n\t\t}\n\t}\n}\nvar cbs = document.createElement('script');\ncbs.setAttribute('src','https://reveal.clearbit.com/v1/companies/reveal?authorization=pk_bcf6023ac7569a6d92f7af8c606484a1&callback=_pCbCallback&variable=_cbResponse');\ndocument.body.appendChild(cbs);"},id:"321ac847-6416-4741-90b5-a9ed58fd41f9",start_bucket:0,context_criteria:{criteria:[{key:"url",value:"verdict.co.uk",comparison:"CONTAINS"},{key:"url",value:"technology.com",comparison:"CONTAINS"},{key:"url",value:"water-technology.net",comparison:"CONTAINS"},{key:"url",value:"designbuild-network.com",comparison:"CONTAINS"},{key:"url",value:"packaging-gateway.com",comparison:"CONTAINS"},{key:"url",value:"medicaldevice-network.com",comparison:"CONTAINS"},{key:"url",value:"verdictfoodservice.com",comparison:"CONTAINS"},{key:"url",value:"hospitalmanagement.net",comparison:"CONTAINS"},{key:"url",value:"hotelmanagement-network.com",comparison:"CONTAINS"},{key:"url",value:"drinks-insight-network.com",comparison:"CONTAINS"},{key:"url",value:"retail-insight-network.com",comparison:"CONTAINS"}],operator:"OR"},segment_code:2491}]},{id:"57183ae6-2fc4-47b0-96be-0b295b26f6f4",reaction_type:"run_script",trigger_type:"EveryTime",variants:[{config:{script:"window._pCbCallback = function(response) {\n\tif (response) {\n\t\tvar xhttp = new XMLHttpRequest();\n\t\txhttp.open('POST', '/clearbit', true);\n\t\txhttp.setRequestHeader('Content-Type', 'application/json');\n\t\txhttp.send(JSON.stringify(response));\n  \t\tpermutive.track(\"Clearbit\", response);\n  \t\tif(window._tgCallback){\n  \t\t\twindow._tgCallback(response)\n\t\t}\n\t}\n}\nvar cbs = document.createElement('script');\ncbs.setAttribute('src','https://reveal.clearbit.com/v1/companies/reveal?authorization=pk_bcf6023ac7569a6d92f7af8c606484a1&callback=_pCbCallback&variable=_cbResponse');\ndocument.body.appendChild(cbs);"},id:"961a8853-ff80-4380-80ec-5cef48dbff72",start_bucket:0,context_criteria:{criteria:[{key:"url",value:"compelo.com",comparison:"CONTAINS"}],operator:"AND"},segment_code:2491}]},{id:"d59f79c7-bb3b-4448-8a55-0b4e900bc655",reaction_type:"run_script",trigger_type:"EveryTime",variants:[{id:"f2f9b7a1-ddd9-4d26-b79c-749f8e7ccfc1",start_bucket:0,config:{script:'var trackHighestBids = function() {\n  try {\n    if (pbjs) {\n      var allBids = pbjs.getBidResponses();\n      var winningBids = pbjs.getAllWinningBids();\n\n      var winningBidAdIds = {};\n      for (var i = 0; i < winningBids.length; i++) {\n        winningBidAdIds[winningBids[i].adId] = 1;\n      }\n\n      var bids = [];\n      for (slot in allBids) {\n        var sb = allBids[slot].bids;\n        var slotBids = sb.sort(function(a, b) {\n          return (b.cpm || 0) - (a.cpm || 0);\n        });\n        for (i = 0; i < slotBids.length && i < 5; i++) {\n          var bid = slotBids[i];\n          if (bid.cpm && bid.cpm > 0) {\n            var obj = {};\n            if (bid.adId) obj["ad_id"] = bid.adId;\n            if (bid.adUnitCode) obj["ad_unit_code"] = bid.adUnitCode;\n            if (bid.bidder) obj["bidder"] = bid.bidder;\n            if (bid.dealId) obj["deal_id"] = bid.dealId;\n            if (bid.cpm) obj["cpm"] = bid.cpm;\n            if (bid.adserverTargeting && bid.adserverTargeting.hb_pb) obj["hb_pb"] = bid.adserverTargeting.hb_pb;\n            if (bid.height) obj["height"] = parseInt(bid.height);\n            if (bid.width) obj["width"] = parseInt(bid.width);\n            if (bid.timeToRespond) obj["time_to_respond"] = bid.timeToRespond;\n            obj["bid_available"] = (bid.statusMessage && bid.statusMessage.indexOf("empty") < 0);\n            if (obj["bid_available"]) obj["winning_bid"] = (bid.adId && bid.adId in winningBidAdIds);\n            bids.push(obj);\n\n            if (obj["winning_bid"]) {\n\t\t\t\t\t\t\tvar objBid = {};\n\t            if (bid.adId) objBid["ad_id"] = bid.adId;\n\t            if (bid.adUnitCode) objBid["ad_unit_code"] = bid.adUnitCode;\n\t            if (bid.bidder) objBid["bidder"] = bid.bidder;\n\t            if (bid.dealId) objBid["deal_id"] = bid.dealId;\n\t            if (bid.cpm) objBid["cpm"] = bid.cpm;\n\t            if (bid.adserverTargeting && bid.adserverTargeting.hb_pb) objBid["hb_pb"] = bid.adserverTargeting.hb_pb;\n\t            if (bid.height) objBid["height"] = parseInt(bid.height);\n\t            if (bid.width) objBid["width"] = parseInt(bid.width);\n\t            if (bid.timeToRespond) objBid["time_to_respond"] = bid.timeToRespond;\n\t            objBid["bid_available"] = (bid.statusMessage && bid.statusMessage.indexOf("empty") < 0);\n\t            if (objBid["bid_available"]) objBid["winning_bid"] = (bid.adId && bid.adId in winningBidAdIds);\n\t\n              permutive.track("PrebidWinningBid", objBid)\n            }\n\n          }\n        }\n      }\n\n      permutive.track("PrebidBids", {bids: bids});\n    }\n  } catch (e) { /*ignore*/ }\n}\nsetTimeout(trackHighestBids, 5000);'},segment_code:2491}]},{id:"37aee398-718a-4804-83c9-a1fc29776cb6",reaction_type:"run_script",trigger_type:"EveryTime",variants:[{config:{script:"window._pCbCallback = function(response) {\n\tif (response) {\n\t\tvar xhttp = new XMLHttpRequest();\n\t\txhttp.open('POST', '/clearbit', true);\n\t\txhttp.setRequestHeader('Content-Type', 'application/json');\n\t\txhttp.send(JSON.stringify(response));\n  \t\tpermutive.track(\"Clearbit\", response);\n  \t\tif(window._tgCallback){\n  \t\t\twindow._tgCallback(response)\n\t\t}\n\t}\n}\nvar cbs = document.createElement('script');\ncbs.setAttribute('src','https://reveal.clearbit.com/v1/companies/reveal?authorization=pk_bcf6023ac7569a6d92f7af8c606484a1&callback=_pCbCallback&variable=_cbResponse');\ndocument.body.appendChild(cbs);"},id:"f1c9d672-ece3-4c38-a6d7-c086bbce7a26",start_bucket:0,context_criteria:{criteria:[{key:"url",value:"globaldata.com",comparison:"CONTAINS"}],operator:"AND"},segment_code:2491}]},{id:"3f6485d0-1b9c-442d-ab02-1d2e88fa4cc4",reaction_type:"run_script",trigger_type:"EveryTime",variants:[{config:{script:"window._pCbCallback = function(response) {\n\tif (response) {\n\t\tvar xhttp = new XMLHttpRequest();\n\t\txhttp.open('POST', '/clearbit', true);\n\t\txhttp.setRequestHeader('Content-Type', 'application/json');\n\t\txhttp.send(JSON.stringify(response));\n  \t\tpermutive.track(\"Clearbit\", response);\n  \t\tif(window._tgCallback){\n  \t\t\twindow._tgCallback(response)\n\t\t}\n\t}\n}\nvar cbs = document.createElement('script');\ncbs.setAttribute('src','https://reveal.clearbit.com/v1/companies/reveal?authorization=pk_bcf6023ac7569a6d92f7af8c606484a1&callback=_pCbCallback&variable=_cbResponse');\ndocument.body.appendChild(cbs);"},id:"b712a03f-ecd7-4c01-a22c-87478c90db4a",start_bucket:0,context_criteria:{criteria:[{key:"url",value:"tech.newstatesman.com",comparison:"CONTAINS"},{key:"url",value:"meed.com",comparison:"CONTAINS"},{key:"url",value:"retail-banker-international.com",comparison:"CONTAINS"},{key:"url",value:"private-banker-international.com",comparison:"CONTAINS"},{key:"url",value:"leasing-life.com",comparison:"CONTAINS"},{key:"url",value:"motor-finance-online",comparison:"CONTAINS"},{key:"url",value:"life-insurance-international.com",comparison:"CONTAINS"},{key:"url",value:"electronic-payments-international.com",comparison:"CONTAINS"},{key:"url",value:"cards-international.com",comparison:"CONTAINS"},{key:"url",value:"worldoffinewine.com",comparison:"CONTAINS"}],operator:"OR"},segment_code:2491}]},{id:"0d97fd72-6b2b-499c-aaf1-baef83804440",reaction_type:"run_script",trigger_type:"EveryTime",variants:[{config:{script:"window._pCbCallback = function(response) {\n\tif (response) {\n  \t\twindow.permutive.track(\"MagazineClearbit\", response);\n\t}\n}\nvar cbs = document.createElement('script');\ncbs.setAttribute('src','https://reveal.clearbit.com/v1/companies/reveal?authorization=pk_bcf6023ac7569a6d92f7af8c606484a1&callback=_pCbCallback&variable=_cbResponse');\ndocument.body.appendChild(cbs);"},id:"199059ac-2817-4145-a9a7-a217acac202f",start_bucket:0,context_criteria:{criteria:[{key:"url",value:"designbuild.nridigital",comparison:"CONTAINS"},{key:"url",value:"defence.nridigital",comparison:"CONTAINS"},{key:"url",value:"inside-drinks.nridigital",comparison:"CONTAINS"},{key:"url",value:"inside-food.nridigital",comparison:"CONTAINS"},{key:"url",value:"inside-packaging.nridigital",comparison:"CONTAINS"},{key:"url",value:"power.nridigital",comparison:"CONTAINS"},{key:"url",value:"mine.nridigital",comparison:"CONTAINS"},{key:"url",value:"offshore.nridigital",comparison:"CONTAINS"},{key:"url",value:"verdict-payments.nridigital",comparison:"CONTAINS"},{key:"url",value:"retail-banker.nridigital",comparison:"CONTAINS"},{key:"url",value:"private-banker.nridigital",comparison:"CONTAINS"},{key:"url",value:"motor-finance.nridigital",comparison:"CONTAINS"},{key:"url",value:"verdict-insurtech.nridigital",comparison:"CONTAINS"},{key:"url",value:"leasing.nridigital",comparison:"CONTAINS"},{key:"url",value:"medical-technology.nridigital",comparison:"CONTAINS"},{key:"url",value:"pharma.nridigital",comparison:"CONTAINS"},{key:"url",value:"brite.nridigital",comparison:"CONTAINS"},{key:"url",value:"verdict-ai.nridigital",comparison:"CONTAINS"},{key:"url",value:"verdict-emerge.nridigital",comparison:"CONTAINS"},{key:"url",value:"verdict-encrypt.nridigital",comparison:"CONTAINS"},{key:"url",value:"airport.nridigital",comparison:"CONTAINS"},{key:"url",value:"future-cruise.nridigital",comparison:"CONTAINS"},{key:"url",value:"rail.nridigital",comparison:"CONTAINS"},{key:"url",value:"ship.nridigital",comparison:"CONTAINS"}],operator:"OR"},segment_code:2491}]}],this.specializedReactionsConfig={target_dfp:{dfp:[2491],dfp_legacy:{}},eyeota_pixel:[],dbm:{omitted:0},appnexus:{},nativo:[]},this.reactions={},this.hasher=function(e){for(var t=0,n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t&=t;return t}}return e.prototype.load=function(){for(var e=0;e<this.reactionsConfig.length;e++){var t=this.reactionsConfig[e];this.reactions[t.reaction_type]?this.reactions[t.reaction_type].push(t):this.reactions[t.reaction_type]=[t]}},e.prototype.evaluateContextCriteria=function(e){for(var t=0;t<e.criteria.length;t++){var n=function(e){var t=permutive.context[e.key];return void 0!==t&&("EQUALS"===e.comparison?t===e.value:"NOT_EQUALS"===e.comparison?t!==e.value:"CONTAINS"===e.comparison?t.indexOf(e.value)>=0:"NOT_CONTAINS"===e.comparison&&t.indexOf(e.value)<0)}(e.criteria[t]);if("AND"===e.operator&&!n)return!1;if("OR"===e.operator&&n)return!0}return"AND"===e.operator},e.prototype.selectVariant=function(e,t){if(1===t.length)return t[0];var n=this.state.userId+e,r=Math.abs(this.hasher(n))%12e4;t.sort(function(e,t){return e.start_bucket-t.start_bucket});var i=t.findIndex(function(e){return r<e.start_bucket});return t[i>=0?i-1:t.length-1]},e.prototype.getSpecializedReactions=function(e){return this.specializedReactionsConfig[e]},e.prototype.getReactions=function(e){var t=[];if(this.reactions[e])for(var n=0;n<this.reactions[e].length;n++){var r=this.reactions[e][n],i=this.selectVariant(r.id,r.variants);if(i){var a=i.context_criteria;a&&!this.evaluateContextCriteria(a)||t.push(new PermutiveReaction(r.id,i.segment_code,"",r.reaction_type,r.trigger_type,i.id,i.config))}}return t},e}(),PermutiveTaskQueue=function(){function e(){var e=this;this.queue=[],this.nextNotify=null,_internals.messages.on("permutive:taskQueue:update",function(){e.execute()})}return e.prototype.add=function(e){this.queue.push(e),this.notify()},e.prototype.notify=function(){var e=function(){_internals.messages.emit("permutive:taskQueue:update")},t=(new Date).getTime();null===this.nextNotify||this.nextNotify<t-50?(this.nextNotify=t,e()):this.nextNotify<=t&&(this.nextNotify=t+50,window.setTimeout(e,50))},e.prototype.execute=function(){var e=this;if(0!==this.queue.length){for(var t=!1,n=!1,r=0,i=0;i<this.queue.length;i++){var a=this.queue[i];if(a.complete)r+=1;else if(a.started)n=!0,t=t||a.blocks();else{if(a.waits()&&n)break;t||(n=!0,t=t||a.blocks(),a.execute(function(){e.notify()}))}}this.queue.splice(0,r)}},e.prototype.size=function(){return this.queue.length},e}(),Task=function(){function e(e,t){void 0===t&&(t={}),this.wait_prev=t.wait_prev||!1,this.block_next=t.block_next||!1,this.description=t.description||"",this.started=!1,this.complete=!1,this.task=e}return e.prototype.waits=function(){return this.wait_prev},e.prototype.blocks=function(){return this.block_next},e.prototype.execute=function(e){var t=this;this.started=!0,this.task(function(){t.complete=!0,e()})},e}(),SessionManager=function(){function e(e){(e=e||{}).timeout_seconds=e.timeout_seconds||1800,e.session_data_key=e.session_data_key||"permutive-session",this.options=e,this.session_id=null,this.initialize()}return e.prototype.getSessionId=function(){return this.session_id},e.prototype.newSession=function(e){return{session_id:_internals.randomUuid(),last_updated:e}},e.prototype.initialize=function(){var e=new Date,t=_internals.getCookie(this.options.session_data_key),n=this.decodeSessionData(t);if(null===n)n=this.newSession(e);else{var r=this.options.timeout_seconds;e>new Date(n.last_updated.getTime()+1e3*r)?n=this.newSession(e):n.last_updated=e}this.persistSessionData(n),this.session_id=n.session_id},e.prototype.decodeSessionData=function(e){var t=null;try{t=JSON.parse(e)}catch(e){return null}return null!==t&&"object"==typeof t&&t.hasOwnProperty("session_id")&&t.hasOwnProperty("last_updated")&&(t.last_updated=new Date(t.last_updated),!isNaN(t.last_updated.getTime()))?t:null},e.prototype.persistSessionData=function(e){e.last_updated=e.last_updated.toISOString(),_internals.setCookie(this.options.session_data_key,JSON.stringify(e))},e}(),ISO8601_REGEX=/^([\+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-2])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T\s]((([01]\d|2[0-3])((:?)[0-5]\d)?|24\:?00)([\.,]\d+(?!:))?)?(\17[0-5]\d([\.,]\d+)?)?([zZ]|([\+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/,PermutiveState=function(){function e(){this.taskQueue=new PermutiveTaskQueue;var e=_internals.getNamespacedStorageKey(permutive.config.permutiveDataKey),t=localStorage.getItem(e);this.permutiveData=null===t?{}:JSON.parse(t),this.userId=this.getUserId(),this.isFirstVisitOnDevice=null===this.userId,this.viewId=_internals.randomUuid(),this.eventsCache=new PermutiveEventsCache(this),this.reactionManager=new PermutiveReactionManager(this),this.reactionManager.load(),this.queryManager=new QueryManager(this)}return e.prototype.reset=function(){_internals.log("Resetting SDK"),this.queryManager.reset(),this.eventsCache.reset(),_internals.deleteCookie(permutive.config.cookieName),this.permutiveData={},localStorage.removeItem(permutive.config.permutiveDataKey)},e.prototype.getUserId=function(){return _internals.getCookie(permutive.config.cookieName)},e.prototype.setUserId=function(e){_internals.setCookie(permutive.config.cookieName,e),this.userId=e},e.prototype.getPermutiveData=function(e){return this.permutiveData[e]},e.prototype.setPermutiveData=function(e,t){this.permutiveData[e]=t;var n=_internals.getNamespacedStorageKey(permutive.config.permutiveDataKey);localStorage.setItem(n,JSON.stringify(this.permutiveData))},e.prototype.getPageviewId=function(){return this.getViewId()},e.prototype.getViewId=function(){return this.viewId},e.prototype.getClient=function(){var e="";return e=document.title?document.title:"",{type:"web",user_agent:navigator.userAgent?navigator.userAgent:"",url:window.location.href?window.location.href:"",domain:window.location.hostname?window.location.hostname:"",title:e,referrer:document.referrer?document.referrer:""}},e}(),PermutiveApi=function(){function e(){}return e.prototype.identify=function(e,t){if(void 0===t&&(t={}),e.forEach(function(e){return _internals.identities.addAlias(e.id,e.tag)}),_internals.isIdentityReady){var n=_internals.identities.currentAliases;this.sendIdentify(_internals.state.userId,n,t).then(function(e){return _internals.identities.storeAliases(n)})}},e.prototype.sendIdentify=function(e,t,n){void 0===n&&(n={});var r={default:0},i=function(e){return _internals.identities.getIdentity(e).defined?e in r?r[e]+1:1:0},a={user_id:e,aliases:function(e){return Object.keys(e).map(function(t){return{id:e[t],tag:t,priority:i(t)}})}(t)};return _internals.req({url:_internals.getEndpointUrl("/identify"),method:"POST",data:a,success:n.success,error:n.error,complete:n.complete,contentType:"text/plain",apiKeyInParams:!0})},e.prototype.setUserProperties=function(e,t){return void 0===t&&(t={}),_internals.req({url:_internals.getEndpointUrl("/users/"+_internals.state.userId+"/properties"),method:"POST",data:{properties:e},success:t.success,error:t.error,complete:t.complete,contentType:"text/plain",apiKeyInParams:!0})},e.prototype.metrics=function(e,t){return void 0===t&&(t={}),_internals.req({url:_internals.getEndpointUrl("/internal/metrics"),method:"POST",data:e,contentType:"text/plain",dataType:"text",apiKeyInParams:!0,success:function(e){t.success&&t.success(e)},error:function(e,n){t.error&&t.error(n)}})},e.prototype.track=function(e,t,n,r,i,a){void 0===a&&(a={});var s=n||{};a.includeClient=(a.includeClient,!0),a.includeClient&&(s.client=_internals.state.getClient());var o={user_id:e,name:t,segments:_internals.state.queryManager.userSegments,properties:s};return null!==r&&(o.session_id=r),null!==i&&(o.view_id=i),_internals.req({url:_internals.getEndpointUrl("/events"),method:"POST",data:o,success:function(e){a.success&&a.success(e)},error:function(e,t){a.error&&a.error(t)},complete:a.complete,contentType:"text/plain",apiKeyInParams:!0,useBeacon:a.useBeacon})},e.prototype.events=function(e,t){void 0===t&&(t={});var n=_internals.getEndpointUrl("/events")+"?user_id="+e;return t.from&&(n+="&from="+t.from.toISOString()),_internals.req({url:n,method:"GET",success:function(e){t.success&&t.success(e)},error:function(e,n){t.error&&t.error(n)},complete:t.complete,apiKeyInParams:!0,contentType:"text/plain"})},e.prototype.tpd=function(e,t){void 0===t&&(t={});var n=_internals.getEndpointUrl("/tpd");return _internals.req({url:n,method:"POST",data:{user_id:e},success:function(e){t.success&&t.success(e)},error:function(e,n){t.error&&t.error(n)},complete:t.complete,contentType:"text/plain",apiKeyInParams:!0})},e}(),PermutiveMethods=function(){function e(){}return e.prototype.identify=function(e){_internals.log("<call> identify",e);var t=PermutiveIdentities.getAliasesFromIdentifyArg(e),n=PermutiveUtils.deferredPromise();if(_internals.api){_internals.state.taskQueue.add(new Task(function(e){_internals.log("<task> identify ",t);var r=_internals.state.userId,i={success:function(i){var a=i.user_id;if(a!==r){var s={error:function(){_internals.error("couldn't retrieve events for user "+a),e(),n.resolve()},from:new Date(0)};_internals.state.reset(),_internals.state.setUserId(a),_internals.state.eventsCache.refresh(s).then(function(r){var i=_internals.state.eventsCache.processRefreshEvents(r,{write:!0});_internals.state.queryManager.updateSegmentResults(i),_internals.state.queryManager.initWorker(i).then(function(){_internals.log("<done> identify",t,i),e(),n.resolve()})})}else _internals.log("<done> identify ",t),e(),n.resolve()},error:function(){_internals.error("Couldn't set identity for user "+r),e(),n.resolve()}};_internals.api.identify(t,i)},{wait_prev:!0,block_next:!0}))}else _internals.error("The API hasn't been loaded."),n.reject();return n.promise},e.prototype.track=function(e,t,n){void 0===n&&(n={}),_internals.log("<call> track",e);var r=PermutiveUtils.deferredPromise();if(_internals.api){var i=n.success;_internals.state.taskQueue.add(new Task(function(a){_internals.log("<task> track",e);var s=_internals.sessionManager.getSessionId(),o=_internals.state.getViewId(),c=!!n.isAnalyticsOnly;_internals.api.track(_internals.state.userId,e,t,s,o,{useBeacon:n.useBeacon,success:function(e){if(isTrackError(e))_internals.log("Tracking failed with reason",e),r.resolve({});else{var t={};n.useBeacon||(t=_internals.state.eventsCache.createEvent(e),c||(_internals.state.eventsCache.add(t),_internals.state.queryManager.update([t]))),i&&i(t),r.resolve(t)}},complete:function(){_internals.log("<done> track",e),a()}})}))}else _internals.error("The API hasn't been loaded."),r.reject();return r.promise},e.prototype.trigger=function(e,t,n){var r=PermutiveUtils.deferredPromise();_internals.log("<call> trigger",e),_internals.triggerListeners=_internals.triggerListeners||[];return _internals.state.taskQueue.add(new Task(function(t){_internals.log("<task> trigger",e);var i=_internals.messages.on("permutive:query:changed",function(t){t.queryCode===e&&(n(t.result),r.resolve(t.result))});_internals.triggerListeners.push(i),_internals.log("<done> trigger",e),t()})),r.promise},e.prototype.query=function(e,t){var n=PermutiveUtils.deferredPromise();_internals.log("<call> query",e);return _internals.state.taskQueue.add(new Task(function(r){_internals.log("<task> query",e),_internals.state.queryManager.handleResult(e,function(e){t(e),n.resolve(e)}),_internals.log("<done> query",e),r()})),n.promise},e.prototype.segment=function(e,t){var n=PermutiveUtils.deferredPromise();_internals.log("<call> segment",e);return _internals.state.taskQueue.add(new Task(function(r){_internals.log("<task> segment",e),_internals.state.queryManager.handleResult(e,function(r){if("boolean"!=typeof r.result)throw new Error("Segment "+e+" is missing boolean result property");t(r.result),n.resolve(r.result)}),_internals.log("<done> segment",e),r()})),n.promise},e.prototype.segments=function(e,t){void 0===t&&(t="all");var n=PermutiveUtils.deferredPromise();_internals.log("<call> segments");return _internals.state.taskQueue.add(new Task(function(r){_internals.log("<task> segments ("+t+")");var i=function(i){e(i),n.resolve(i),_internals.log("<done> segments ("+t+")"),r()};"dfp"===t?void 0!==_internals.addons.dfp&&_internals.addons.dfp.isReady?i(_internals.addons.dfp.liveSegments):_internals.messages.once("permutive:dfp:ready",function(){i(_internals.addons.dfp.liveSegments)}):i(_internals.state.queryManager.userSegments)})),n.promise},e.prototype.reset=function(){var e=PermutiveUtils.deferredPromise();return _internals.createUser(function(t){_internals.state.reset(),_internals.state.setUserId(t.user_id),_internals.state.eventsCache.refresh({error:function(){return e.resolve()}}).then(function(e){var t=_internals.state.eventsCache.processRefreshEvents(e,{write:!0});return _internals.state.queryManager.updateWithHistoricSegments(t)}).then(function(){return e.resolve()}),_internals.messages.emit("permutive:reset")}),e.promise},e.prototype.addon=function(e,t){if(_internals.addons[e])"web"===e&&!0!==t.auto_init&&_internals.addons[e].reset(t);else switch(e){case"web":_internals.addons.web=new WebAddon(t);break;case"publishers":_internals.addons.publishers=new PublishersAddon(t);break;case"overlays":_internals.addons.overlays=new OverlaysAddon(t);break;case"scriptrunner":_internals.addons.scriptrunner=new ScriptRunnerAddon(t);break;case"dfp":_internals.addons.dfp=new DFPAddon(t);break;case"smart":_internals.addons.smart=new SmartAddon(t);break;case"nativo":_internals.addons.nativo=new NativoAddon(t);break;case"freewheel":_internals.addons.freewheel=new FreeWheelAddon(t);break;case"gigya":_internals.addons.gigya=GigyaAddon(t);break;case"facebook_pixel":_internals.addons.facebook_pixel=new FacebookPixelAddon(t);break;case"facebook_pixel_v2":_internals.addons.facebook_pixel_v2=new FacebookPixelV2Addon(t);break;case"eyeota_pixel":_internals.addons.eyeota_pixel=new EyeotaPixelAddon(t);break;case"pubmatic":_internals.addons.pubmatic=new PubMaticAddon(t);break;case"tradedesk":_internals.addons.tradedesk=new TradeDeskAddon(t);break;case"adwords":case"dbm":_internals.addons.ddp=new DDPAddon(t);break;case"rubicon":_internals.addons.rubicon=new RubiconAddon(t);break;case"aol":_internals.addons.aol=new AOLAddon(t);break;case"lotame":_internals.addons.lotame=new LotameAddon(t);break;case"tracking_pixel":_internals.addons.tracking_pixel=new PixelAddon(t);break;case"twitter_pixel":_internals.addons.twitter_pixel=new TwitterAddon(t);break;case"pinterest_pixel":_internals.addons.pinterest_pixel=new PinterestAddon(t);break;case"local_storage":_internals.addons.local_storage=new LocalStorageAddon(t);break;case"appnexus":_internals.addons.appnexus=new AppNexusAddon(t)}},e.prototype.ready=function(e,t){void 0===t&&(t="initialised");var n=PermutiveUtils.deferredPromise();switch(t){case"initialised":_internals.isReady?(e(),n.resolve()):_internals.messages.on("permutive:ready",function(){e(),n.resolve()});break;case"realtime":_internals.isRealtime?(e(),n.resolve()):_internals.messages.once("permutive:realtime",function(){e(),n.resolve()})}return n.promise},e}(),PermutiveIdentities=function(){function e(){this.identities=_internals.state.getPermutiveData("identities")||{},this.previousAliases=_internals.state.getPermutiveData("aliases")||{},this.currentAliases=_internals.state.getPermutiveData("aliases")||{},this.providers={}}return e.getAliasesFromIdentifyArg=function(e){var t=this;if("string"!=typeof e&&"object"!=typeof e||null===e||""===e)throw new Error("Identify must be passed a non-empty string or list of aliases, value passed was '"+e+"'");var n="string"==typeof e?[{id:e,tag:"default"}]:e,r=n.filter(function(e){return t.reservedAliasTags.indexOf(e.tag)>-1}).map(function(e){return e.id});if(r.length>0)throw new Error("Identify was called with one or more reserved alias tags: "+r.join(","));return n},e.prototype.setIdentity=function(e,t,n){void 0===n&&(n=86400),this.identities[e]={value:t,expiry:Date.now()+Math.floor(1e3*n)},_internals.state.setPermutiveData("identities",this.identities)},e.prototype.getIdentity=function(e){return e in this.identities?{defined:!0,value:this.identities[e].value}:{defined:!1,value:void 0}},e.prototype.getIdentities=function(e){var t=this;return void 0===e&&(e=!1),Object.keys(this.identities).reduce(function(n,r){var i=t.getIdentity(r).value;return void 0!==i&&(e&&!t.getProvider(r).usedForThirdPartyData()||(n[r]=i)),n},{})},e.prototype.hasExpired=function(e){return!(e in this.identities)||Date.now()>=this.identities[e].expiry},e.prototype.registerProvider=function(e){this.providers[e.getTag()]=e},e.prototype.getProvider=function(e){return e in this.providers?this.providers[e]:(_internals.error("Identity provider "+e+" is not registered."),null)},e.prototype.retrieveIdentity=function(e){var t=this,n=this.getProvider(e);return null===n?Promise.resolve(void 0):n.getId().then(function(e){var r=void 0===e?"sdk_third_party_identity_missing_count":"sdk_third_party_identity_present_count";return _internals.metrics.track({name:r,value:1,labels:{identity_tag:n.getTag()}}),t.setIdentity(n.getTag(),e,n.getTtlInSeconds()),e})},e.prototype.retrieveAllIdentities=function(){_internals.metrics.startTimer("sdk_get_third_party_identities_task_duration_seconds",{});var e=[],t=this;for(var n in this.providers)!function(n){if(!t.providers.hasOwnProperty(n))return"continue";var r=t.getIdentity(n),i=!r.defined||t.hasExpired(n)?t.retrieveIdentity(n):Promise.resolve(r.value);i.then(function(e){return void 0!==e?_internals.api.identify([{id:e,tag:n}]):null}),e.push(i)}(n);return Promise.all(e).then(function(e){return _internals.metrics.stopTimer("sdk_get_third_party_identities_task_duration_seconds",{}),e})},e.prototype.addAlias=function(e,t){this.currentAliases[t]=e},e.prototype.storeAliases=function(e){_internals.state.setPermutiveData("aliases",e)},e.prototype.areAliasesEqual=function(e,t){var n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(var i=0;i<n.length;i++){var a=n[i];if(!(a in t))return!1;if(t[a]!==e[a])return!1}return!0},e.reservedAliasTags=["appnexus","amp","gigya","sailthru","idfa","aaid"],e}(),providerToIdMap={permutive:"1",eyeota:"2",nielsen:"3",skimlinks:"4",comscore:"5",eyeota_bombora:"6",eyeota_aimmatic:"7",eyeota_alc:"8",eyeota_amberdata:"9",eyeota_caci:"10",eyeota_corelogic:"11",eyeota_dlg:"12",eyeota_dataxpand:"13",eyeota_dunbradstreet:"14",eyeota_experian:"15",eyeota_gbgtransactis:"16",eyeota_gfk:"17",eyeota_rdaresearch:"18",eyeota_kantarmedia:"19",eyeota_mastercard:"20",eyeota_meritdirect:"21",eyeota_netsprint:"22",eyeota_nri:"23",eyeota_onaudience:"24",eyeota_pacificdatapartners:"25",eyeota_plungedigital:"26",eyeota_roymorgan:"27",eyeota_schober:"28",eyeota_sharethis:"30",eyeota_skimlinks:"31",eyeota_specialists:"32",eyeota_statsocial:"33",eyeota_stirista:"34",eyeota_yougov:"36"},PermutiveThirdParty=function(){function e(){this.userSegments=_internals.state.getPermutiveData("third-party-data")||{expiry_time:Date.now()-1,segments:{}},this.ttlInSeconds=86400}return e.prototype.fireThirdPartySegmentEvent=function(){var e=this,t=new Date(_internals.state.getPermutiveData("date_tpd_segment_event_sent")||null);(Date.now()-t.getTime())/864e5>=30&&(Object.keys(this.userSegments.segments).forEach(function(t){permutive.track("ThirdPartySegments",{data_provider:t,segments:Object.keys(e.userSegments.segments[t])},{isAnalyticsOnly:!0})}),_internals.state.setPermutiveData("date_tpd_segment_event_sent",Date.now()))},e.prototype.segments=function(){var e=this;if(this.segmentsPromise)return this.segmentsPromise;if(Date.now()<this.userSegments.expiry_time)return Promise.resolve(this.userSegments.segments);var t=PermutiveUtils.deferredPromise();_internals.metrics.startTimer("sdk_get_third_party_data_task_duration_seconds",{});var n=_internals.identities.getIdentities(!0);Object.keys(n).length>0?_internals.api.tpd(n,{success:function(n){var r=e.convertSegments(n),i=Date.now()+Math.floor(1e3*e.ttlInSeconds);e.userSegments.expiry_time=i,e.updateCache(r),t.resolve(r)},error:function(e){_internals.error("Third Party Data segments retrieval failed with reason: "+e),t.resolve({})}}):t.resolve({});var r=_internals.promises.getPromisesByCategory("tpd"),i=Promise.all(r.map(function(e){return e.promise})).then(function(e){return t.promise}).then(function(t){return e.getSegments()});return i.then(function(){_internals.metrics.stopTimer("sdk_get_third_party_data_task_duration_seconds",{})}),this.segmentsPromise=i,this.segmentsPromise},e.prototype.addSegments=function(e,t){var n={};n[e]=t;var r=this.convertSegments(n);this.updateCache(r)},e.prototype.getSegments=function(){return this.userSegments.segments},e.prototype.getActivationMetadata=function(){var e=_internals.state.queryManager.getActivations(),t={};for(var n in e)if(e.hasOwnProperty(n)){var r=e[n].map(function(e){return[n,providerToIdMap[e.data_provider_id],e.data_provider_segment_id].join("-")});t[n]=r}return t},e.prototype.updateCache=function(e){this.userSegments.segments=PermutiveUtils.mergeNestedObjects(this.userSegments.segments,e),_internals.state.setPermutiveData("third-party-data",this.userSegments)},e.prototype.convertSegments=function(e){return Object.keys(e).reduce(function(t,n){var r=e[n];return t[n]=r.reduce(function(e,t){return e[t]=!0,e},{}),t},{})},e}(),PermutiveModels;permutive.addons=_internals.addons;try{var metricsEnabled=void 0!==sdkInitTimestamp&&Math.random()<=_internals.config.metricsSamplingPercentage/100;_internals.metrics=metricsEnabled?new PermutiveMetrics(sdkInitTimestamp):new PermutiveMetricsNoOp,_internals.sessionManager=new SessionManager,_internals.state=new PermutiveState;var eventCache_1=_internals.state.eventsCache.load();_internals.models={getModels:function(){return Promise.resolve({})}},_internals.api=new PermutiveApi,_internals.identities=new PermutiveIdentities,_internals.thirdParty=new PermutiveThirdParty,permutive.context=permutive.context||{},permutive.context.path=window.location.pathname,permutive.context.url=window.location.href,permutive.context.referrer=document.referrer,_internals.blockers=[],_internals.addBlocker("permutive:queries:initialised");for(var scripts=[],i=0;i<scripts.length;i++){var script=scripts[i];try{eval(script)}catch(e){e.message="Error running custom script ["+i+"]"+e.message,_internals.error(e)}}permutive.q.push({functionName:"addon",arguments:["web",{auto_init:!0}]});var WebAddon=function(){function e(e){var t=this,e=e||{};this.eventInterval=e.eventInterval||5,this.initialised=!1,this.addAlchemyTaxonomy={auto_init:!0}.add_alchemy_taxonomy,this.addAlchemyEntities={auto_init:!0}.add_alchemy_entities,this.trackPageviewEngagement="boolean"!=typeof{auto_init:!0}.track_pageview_engagement||{auto_init:!0}.track_pageview_engagement,this.trackFormSubmission="boolean"!=typeof{auto_init:!0}.track_form_submission||{auto_init:!0}.track_form_submission,this.trackLinkClick="boolean"!=typeof{auto_init:!0}.track_link_click||{auto_init:!0}.track_link_click,this.page=e.page||null,this.sendPageviewEvent(),this.dirtyState=!1;var n=function(){t.dirtyState=!0};(e.dirtyEvents||["mousemove","click","scroll"]).map(function(e){window.addEventListener(e,n)}),this.totalCompletion=0,this.trackPageviewEngagement&&(this.timerHandle=setInterval(this.sendEngagementEvent(this.eventInterval,this.getCompletion),1e3*this.eventInterval));var r=function(){if(t.trackFormSubmission)for(var e=window.document.getElementsByTagName("form"),n=0;n<e.length;n++)e[n].addEventListener("submit",makeSafe(t.sendFormSubmissionEvent))},i=function(e,t){if(e.tagName.toLowerCase()===t)return e;for(var n=e.parentElement;null!==n;){if(n.tagName.toLowerCase()===t)return n;n=n.parentElement}return null};this.trackLinkClick&&document.body.addEventListener("click",function(e){var n=i(e.target,"a");if(n){var r=!("_blank"===n.target||e.metaKey||e.ctrlKey||e.shiftKey||2===e.which||3===e.which);t.sendLinkClickEvent(n,r)}}),"loading"!==document.readyState?r():window.addEventListener("DOMContentLoaded",r,!1),this.initialised=!0}return e.prototype.sendPageviewEvent=function(){var e={visit_id:_internals.state.getViewId(),isp_info:"$ip_isp_info",geo_info:"$ip_geo_info",alchemy:void 0};if(!0===permutive.context.isArticle&&(this.addAlchemyTaxonomy||this.addAlchemyEntities)){var t={};this.addAlchemyTaxonomy&&(t.taxonomy_labels="$alchemy_taxonomy_labels"),this.addAlchemyEntities&&(t.entity_names="$alchemy_entity_names"),e.alchemy=t}null!==this.page&&(e=PermutiveUtils.extend(e,this.page));var n={};this.initialised||(n.success=function(){_internals.metrics.trackTimeSinceInit("sdk_first_event_tracked_task_duration_seconds",{})}),permutive.track("Pageview",e,n)},e.prototype.getCompletion=function(){var e=document.documentElement.scrollHeight,t=window.pageYOffset+window.innerHeight;return t<=0?0:t>=e?1:t/e},e.prototype.sendEngagementEvent=function(e,t){var n=this;return makeSafe(function(){if(n.dirtyState){var r={visit_id:_internals.state.getViewId(),engaged_time:e},i=Math.max(n.totalCompletion,t());r.completion=i-n.totalCompletion,n.totalCompletion=i,n.dirtyState=!1,null!==n.page&&(r=PermutiveUtils.extend(r,n.page)),permutive.track("PageviewEngagement",r)}})},e.prototype.reset=function(e){_internals.state.viewId=_internals.randomUuid(),this.page=e.page||null,this.totalCompletion=0,this.sendPageviewEvent(),this.trackPageviewEngagement&&(clearInterval(this.timerHandle),this.timerHandle=setInterval(this.sendEngagementEvent(this.eventInterval,this.getCompletion),1e3*this.eventInterval))},e}();WebAddon.prototype.sendLinkClickEvent=function(e,t){window.location.href&&e.href&&permutive.track("LinkClick",{dest_url:e.href},{useBeacon:t})},WebAddon.prototype.sendFormSubmissionEvent=function(e){var t=function(e){for(var t,n,r,i={},a=function(e){if(e.forEach)return e.forEach(a);e&&e.length<=120&&(i[n]=e.toString())},s=e.getElementsByTagName("input"),o=0;o<s.length;o++){var c=s[o];t=c.id,r=c.type;var u=!1;(n=c.name||t)&&r&&t&&"email"!==r.toLowerCase()&&"tel"!==r.toLowerCase()||(u=!0),u||"fieldset"===c.nodeName.toLowerCase()||c.disabled||"submit"===r||"reset"===r||"button"===r||"file"===r||"password"===r||!("radio"!==r&&"checkbox"!==r||c.checked)||a(document.getElementById(c.id).value)}return i}(e.currentTarget),n=[];for(var r in t)n.push({name:r,value:t[r]});var i={method:this.method||"GET",properties:n};this.id&&(i.id=this.id),this.name&&"string"==typeof this.action&&(i.name=this.name),this.action&&"string"==typeof this.action&&(i.action=this.action),permutive.track("FormSubmission",{form:i})},permutive.q.unshift({functionName:"addon",arguments:["overlays",{}]});var isHtmlOverlay_1=function(e){return void 0!==e.html},isImageOverlay_1=function(e){return void 0!==e.image_url&&void 0!==e.image_link},OverlaysAddon=function(){function e(e){var t=this;this.reactions=_internals.state.reactionManager.getReactions("show_overlay"),this.loadedImageCounts={};for(var n=this,r=0;r<this.reactions.length;r++)!function(){var e=n.reactions[r],i=e.config,a=n.buildOverlayCss(i,r);document.head.insertAdjacentHTML("beforeend",a);var s=n.buildOverlayBody(i,r);document.body.insertAdjacentHTML("beforeend",s);var o="permutive-overlay-"+r,c=document.getElementById(o);!function(e,t){e.getElementsByClassName("close")[0].addEventListener("click",function(){e.style.visibility="hidden",e.style.opacity="0"})}(c),function(e,t,n){[].slice.call(e.getElementsByTagName("a")).slice(1).forEach(function(e){e.addEventListener("click",function(e){e.preventDefault();var t=this.href;n.trackConversion({success:function(){window.location.href=t}})})});var r=e.getElementsByTagName("form")[0];r&&r.addEventListener("submit",function(e){e.preventDefault(),e.currentTarget,n.trackConversion({success:function(){r.submit()}})})}(c,0,e);var u=function(e,n){t.showOverlay(e),n.trackImpression()};!function(e,t){t.reactEveryTime()?permutive.query(t.segmentCode,makeSafe(function(n){n.result?u(e,t):permutive.trigger(t.segmentCode,"result",function(n){n.result&&u(e,t)})})):t.reactOnEntry()?permutive.trigger(t.segmentCode,"result",makeSafe(function(n){n.result&&u(e,t)})):t.reactOnExit()&&permutive.trigger(t.segmentCode,"result",makeSafe(function(n){n.result||u(e,t)}))}(o,e)}()}return e.prototype.buildOverlayCss=function(e,t){return'<style type="text/css">.${overlay_class}{position:fixed;top:0;bottom:0;left:0;right:0;width:100%;height:100%;background:rgba(0,0,0,0.${opacity_percentage});transition:opacity ${opacity_transition_ms}ms;visibility:hidden;opacity:0;z-index:1000000;}.${modal_class}{position:fixed;padding:10px;background:#fff;border-radius:5px;z-index:1000001}.${modal_class} .content{overflow:auto;z-index:1000002;}.${modal_class} .close{position:absolute;top:20px;right:30px;transition:all 200ms;font-size:30px;font-weight:bold;text-decoration:none;color:#333;z-index:1000003}.${modal_class} .close:hover{color:orange;}</style>'.replace(/\${overlay_class}/g,"permutive-overlay-"+t).replace(/\${modal_class}/g,"permutive-modal-"+t).replace("${opacity_percentage}",e.opacity_percentage.toString()).replace("${opacity_transition_ms}",e.opacity_transition_ms.toString())},e.prototype.buildOverlayBody=function(e,t){var n="";return isHtmlOverlay_1(e)?n=e.html:isImageOverlay_1(e)&&(n='<a href="'+e.image_link+'"><img src="'+e.image_url+'"/></a>'),'<div id="${overlay_class}" class="${overlay_class}"><div id="${modal_class}" class="${modal_class}"><a class="close" href="javascript:;">&times;</a><div class="content">${content}</div></div></div>'.replace(/\${overlay_class}/g,"permutive-overlay-"+t).replace(/\${modal_class}/g,"permutive-modal-"+t).replace("${content}",n).replace(/<img /g,"<img onload='window.permutive.addons.overlays.loadedImage(\"permutive-overlay-"+t+"\")' ")},e.prototype.showOverlay=function(e){var t=this,n=document.getElementById(""+e),r=function(){var e=n.getElementsByTagName("div")[0],t=e.getBoundingClientRect().height,r=e.getBoundingClientRect().width;e.style.left=window.innerWidth/2-r/2+"px",e.style.top=window.innerHeight/2-t/2+"px",n.style.visibility="visible",n.style.opacity="1"},i=n.getElementsByTagName("img");if(i.length>0){var a=0,s=function(){a<10&&(!(e in t.loadedImageCounts)||t.loadedImageCounts[e]<i.length)?(a+=1,setTimeout(s,500)):r()};s()}else r()},e.prototype.loadedImage=function(e){e in this.loadedImageCounts?this.loadedImageCounts[e]=this.loadedImageCounts[e]+1:this.loadedImageCounts[e]=1},e}();permutive.q.unshift({functionName:"addon",arguments:["scriptrunner",{}]});var ScriptRunnerAddon=function(){function ScriptRunnerAddon(options){this.reactions=_internals.state.reactionManager.getReactions("run_script");for(var i=0;i<this.reactions.length;i++){var reaction=this.reactions[i],run=function(reaction){var script=reaction.config.script.replace(/impression\(\)/g,"reaction.trackImpression();").replace(/conversion\(\)/g,"reaction.trackConversion();");try{eval(script)}catch(e){e.message="Error running custom script: "+e.message,_internals.error(e)}};!function(e){e.reactEveryTime()?permutive.query(e.segmentCode,function(t){t.result?run(e):permutive.trigger(e.segmentCode,"result",function(t){t.result&&run(e)})}):e.reactOnEntry()?permutive.trigger(e.segmentCode,"result",function(t){t.result&&run(e)}):e.reactOnExit()&&permutive.trigger(e.segmentCode,"result",function(t){t.result||run(e)})}(reaction)}}return ScriptRunnerAddon}(),DFP_SEGMENTS_STORAGE_KEY="_pdfps",googleAdSlots={};!function(){if(permutive.q.push({functionName:"addon",arguments:["dfp",{}]}),"undefined"!=typeof googletag&&googletag.cmd&&googletag.cmd.push){permutive.ready(makeSafe(function(){var e=0;googletag.pubads&&googletag.pubads().getSlots&&googletag.pubads().getSlots().length>0&&googletag.pubads().getSlots().forEach(function(t){t.getResponseInformation()&&e++});var t=0===e?"sdk_targeting_realtime_success_count":"sdk_targeting_realtime_fail_count";_internals.metrics.track({name:t,value:1,labels:{target:"dfp"}})}),"realtime");var e=function(){var e=_internals.getExternalData(DFP_SEGMENTS_STORAGE_KEY);return e?JSON.parse(e):[]}();googletag.cmd.push(function(){googletag.pubads().setTargeting("permutive",e)});var t=function(e){for(var t={ad_unit_path:e.getAdUnitPath(),slot_element_id:e.getSlotElementId(),targeting_keys:[]},n={},r=e.getTargetingKeys(),i=0;i<r.length;i++){for(var a=r[i],s=[],o=e.getTargeting(a),c=0;c<o.length;c++)s.push(o[c].toString());s.length>0&&(n[a]=1,t.targeting_keys.push({key:a,value:s}))}for(var u=googletag.pubads().getTargetingKeys(),i=0;i<u.length;i++){s=[];if(void 0===n[a=u[i]]){for(var o=googletag.pubads().getTargeting(u[i]),c=0;c<o.length;c++)s.push(o[c].toString());s.length>0&&t.targeting_keys.push({key:a,value:s})}}return t},n=function(e){try{var t=!1;window.addEventListener("blur",function(){if(t){var n=googleAdSlots[e];n&&permutive.track("SlotClicked",n)}}),document.getElementById(e).addEventListener("mouseover",function(){t=!0}),document.getElementById(e).addEventListener("mouseout",function(){t=!1})}catch(e){}};googletag.pubads&&googletag.pubads().getSlots&&googletag.pubads().getSlots().forEach(function(e){var r=e.getResponseInformation();if(r){var i=e.getSlotElementId(),a={advertiser_id:r.advertiserId,campaign_id:r.campaignId,line_item_id:r.lineItemId,creative_id:r.creativeId,is_empty:!1,service_name:"publisher_ads",slot:t(e)};googleAdSlots[i]=a,permutive.track("SlotRendered",a,{isAnalyticsOnly:!0}),n(i)}}),googletag.cmd.push(function(){googletag.pubads().addEventListener("slotRenderEnded",function(e){var r=e,i=r.slot.getSlotElementId(),a={advertiser_id:r.advertiserId,campaign_id:r.campaignId,line_item_id:r.lineItemId,creative_id:r.creativeId,is_empty:r.isEmpty,service_name:r.serviceName,slot:t(e.slot)};r.size&&"number"==typeof r.size[0]&&"number"==typeof r.size[1]&&(a.width=r.size[0],a.height=r.size[1]),googleAdSlots[i]=a,permutive.track("SlotRendered",a,{isAnalyticsOnly:!0}),n(i)})}),window.addEventListener("message",function(e){try{var t=JSON.parse(e.data);if(t.permutive_type&&"google_ad_click"===t.permutive_type){var n=t.data.ad_unit_path,r=t.data.creative_id,i=void 0;Object.keys(googleAdSlots).forEach(function(e){void 0!==googleAdSlots[e].slot&&googleAdSlots[e].slot.ad_unit_path===n&&googleAdSlots[e].creative_id===r&&(i=googleAdSlots[e])}),i=i||{line_item_id:t.data.line_item_id,advertiser_id:t.data.advertiser_id,campaign_id:t.data.order_id,creative_id:r,is_empty:!1},permutive.track("SlotClicked",i)}}catch(e){}},!1)}}();var DFPAddon=function(){function e(e){var t=this;this.trackedTargetingLimitMetric=!1;var n=_internals.getExternalData(DFP_SEGMENTS_STORAGE_KEY);this.liveSegments=n?JSON.parse(n):[],this.eligibleSegments={};for(var r=_internals.state.reactionManager.getSpecializedReactions("target_dfp"),i=0;i<r.dfp.length;i++){var a=r.dfp[i];this.eligibleSegments[a]=a}for(var s in r.dfp_legacy)if(r.dfp_legacy.hasOwnProperty(s)){var o=r.dfp_legacy[s];this.eligibleSegments[s]=o}var c=_internals.state.queryManager.userSegments;this.updateSegments(this.filterSegments(c)),_internals.messages.emit("permutive:dfp:ready"),_internals.messages.on("permutive:segments:updated",makeSafe(function(){var e=_internals.state.queryManager.userSegments;t.updateIfNecessary(e)})),_internals.messages.on("permutive:reset",makeSafe(function(){_internals.removeExternalData(DFP_SEGMENTS_STORAGE_KEY),_internals.deleteCookie(DFP_SEGMENTS_STORAGE_KEY),t.liveSegments=[]}))}return e.prototype.updateIfNecessary=function(e){var t=this.filterSegments(e);_internals.arraysEqual(t,this.liveSegments)||this.updateSegments(t)},e.prototype.updateSegments=function(e){var t=this.processActivations(_internals.thirdParty.getActivationMetadata()),n=e.concat(t);encodeURIComponent(JSON.stringify(n)).length>1500&&(n=e,this.trackedTargetingLimitMetric||(_internals.metrics.track({name:"sdk_targeting_size_limit_exceeded_count",value:1,labels:{target:"dfp"}}),this.trackedTargetingLimitMetric=!0)),"undefined"!=typeof googletag&&googletag.cmd&&googletag.cmd.push&&googletag.cmd.push(function(){googletag.pubads().setTargeting("permutive",n.concat(["rts"]))});var r=JSON.stringify(n);_internals.setExternalData(DFP_SEGMENTS_STORAGE_KEY,r),_internals.setCookie(DFP_SEGMENTS_STORAGE_KEY,r),this.liveSegments=e},e.prototype.filterSegments=function(e){var t=this;return e.filter(function(e){return e in t.eligibleSegments}).map(function(e){return t.eligibleSegments[e]})},e.prototype.processActivations=function(e){var t=[];for(var n in e)if(e.hasOwnProperty(n)&&n in this.eligibleSegments)for(var r=0;r<e[n].length;r++)t.push(e[n][r]);return t},e}();_internals.messages.on("permutive:blockers:empty",function(){var e=new PermutiveMethods;PermutiveUtils.extend(permutive,e),permutive.config.exposeInternals&&PermutiveUtils.extend(permutive,_internals),_internals.setAsReady(),_internals.applyQueue(),delete permutive.q,_internals.messages.emit("permutive:queue:executed")});var retrieveThirdPartyIdentities_1=function(){return _internals.identities.retrieveAllIdentities()},initThirdPartyState=function(){return retrieveThirdPartyIdentities_1().then(function(e){return _internals.thirdParty.segments().then(function(){return _internals.thirdParty.fireThirdPartySegmentEvent()}),e})},initIdentity=function(){var e=PermutiveUtils.deferredPromise();if(_internals.log("<call> init identity "),null===_internals.state.getUserId()){var t=_internals.randomUuid();_internals.log("Cookie user id is null, creating new id: "+t),_internals.state.setUserId(t)}permutive.context.user_id=_internals.state.userId,permutive.q.filter(function(e){return"identify"===e.functionName}).forEach(function(e){return makeSafe(function(){var t=PermutiveIdentities.getAliasesFromIdentifyArg(e.arguments[0]);_internals.api.identify(t)})()}),permutive.q=permutive.q.filter(function(e){return"identify"!==e.functionName});var n=_internals.identities.previousAliases,r=_internals.identities.currentAliases;if(_internals.identities.areAliasesEqual(n,r))_internals.log("Aliases are equal, skipping identifying...",n,r),e.resolve({identityChanged:!1,userId:_internals.state.userId});else{_internals.log("Aliases have changed...",n,r);var i=_internals.state.userId,a={success:function(t){var n=t.user_id,a=!1;n!==i&&(_internals.log("Got different user id from API: "+n),_internals.state.reset(),_internals.state.setUserId(n),a=!0),_internals.identities.storeAliases(r),e.resolve({identityChanged:a,userId:n})},error:function(){_internals.error("Couldn't set identity for user "+i),e.resolve({identityChanged:!1,userId:i})}};_internals.api.sendIdentify(i,r,a)}return e.promise.then(function(e){_internals.messages.emit("permutive:user:ready"),_internals.setIdentityReady(),_internals.log("<done> init identity ",e)}),e.promise},identityChanged_1=function(){_internals.log("Identity has changed");var e=_internals.state.eventsCache.refresh({from:new Date(0)});return _internals.state.eventsCache.setReady(),e.then(function(e){var t=_internals.state.eventsCache.processRefreshEvents(e,{write:!0});return _internals.log("Retrieved full event history from API"),_internals.state.queryManager.updateSegmentResults(t),_internals.state.queryManager.initWorker(t)})},identityRemained_1=function(){_internals.log("Identity hasn't changed");var e=_internals.state.eventsCache.refresh();return eventCache_1.then(function(e){_internals.log("Loaded local event cache");var t=_internals.state.eventsCache.processCachedEvents(e);return _internals.state.eventsCache.setReady(),_internals.state.queryManager.initWorker(t)}).then(function(){return e}).then(function(e){var t=_internals.state.eventsCache.processRefreshEvents(e,{write:!0});return _internals.log("Updating query states with unseen events from API (#e)",t.length),_internals.state.queryManager.updateWithHistoricSegments(t)})};initThirdPartyState().then(initIdentity).then(function(e){return e.identityChanged?identityChanged_1():identityRemained_1()}).then(function(){return Promise.all([_internals.thirdParty.segments(),_internals.models.getModels()]).then(function(e){return _internals.log("Loaded TPD segments and lookalike models",e),_internals.state.queryManager.updateEnvironment({segments:PermutiveUtils.merge({"1p":_internals.state.queryManager.userSegmentsDict},e[0]),lookalikeModels:e[1]})}).then(function(){_internals.state.queryManager.setAsReady()})}).then(function(){_internals.messages.emit("permutive:api:ready")}),_internals.messages.emit("permutive:library:loaded")}catch(e){_internals.error(e)}}var wwSupport=!!window.Worker&&!!window.Blob,mod="modernizr",lsSupport=!0;try{localStorage.setItem(mod,mod),localStorage.removeItem(mod)}catch(e){lsSupport=!1}if(wwSupport&&lsSupport){var sdkInitTimestamp=void 0;void 0!==window.performance&&void 0!==window.performance.now&&(sdkInitTimestamp=performance.now());var LZBlob=new Blob([("("+lzWorkerFunction+")();").replace('"use strict";',"")],{type:"application/javascript"}),LZWorkerBlobURL=URL.createObjectURL(LZBlob),worker=new Worker(LZWorkerBlobURL),counter=0,LZWorker={compress:function(e,t){worker.onmessage=function(e){t(e.data)},worker.postMessage({type:"compress",value:e})},decompress:function(e,t){worker.onmessage=function(e){t(e.data)},worker.postMessage({type:"decompress",value:e})}};!function(e){function t(){}function n(e,t){return function(){e.apply(t,arguments)}}function r(e){if(!(this instanceof r))throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],u(e,this)}function i(e,t){for(;3===e._state;)e=e._value;0!==e._state?(e._handled=!0,r._immediateFn(function(){var n=1===e._state?t.onFulfilled:t.onRejected;if(null!==n){var r;try{r=n(e._value)}catch(e){return void s(t.promise,e)}a(t.promise,r)}else(1===e._state?a:s)(t.promise,e._value)})):e._deferreds.push(t)}function a(e,t){try{if(t===e)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var i=t.then;if(t instanceof r)return e._state=3,e._value=t,void o(e);if("function"==typeof i)return void u(n(i,t),e)}e._state=1,e._value=t,o(e)}catch(t){s(e,t)}}function s(e,t){e._state=2,e._value=t,o(e)}function o(e){2===e._state&&0===e._deferreds.length&&r._immediateFn(function(){e._handled||r._unhandledRejectionFn(e._value)});for(var t=0,n=e._deferreds.length;t<n;t++)i(e,e._deferreds[t]);e._deferreds=null}function c(e,t,n){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=n}function u(e,t){var n=!1;try{e(function(e){n||(n=!0,a(t,e))},function(e){n||(n=!0,s(t,e))})}catch(e){if(n)return;n=!0,s(t,e)}}if(!e.Promise){var l=setTimeout;r.prototype.catch=function(e){return this.then(null,e)},r.prototype.then=function(e,n){var r=new this.constructor(t);return i(this,new c(e,n,r)),r},r.prototype.finally=function(e){var t=this.constructor;return this.then(function(n){return t.resolve(e()).then(function(){return n})},function(n){return t.resolve(e()).then(function(){return t.reject(n)})})},r.all=function(e){return new r(function(t,n){function r(e,s){try{if(s&&("object"==typeof s||"function"==typeof s)){var o=s.then;if("function"==typeof o)return void o.call(s,function(t){r(e,t)},n)}i[e]=s,0==--a&&t(i)}catch(e){n(e)}}if(!e||void 0===e.length)throw new TypeError("Promise.all accepts an array");var i=Array.prototype.slice.call(e);if(0===i.length)return t([]);for(var a=i.length,s=0;s<i.length;s++)r(s,i[s])})},r.resolve=function(e){return e&&"object"==typeof e&&e.constructor===r?e:new r(function(t){t(e)})},r.reject=function(e){return new r(function(t,n){n(e)})},r.race=function(e){return new r(function(t,n){for(var r=0,i=e.length;r<i;r++)e[r].then(t,n)})},r._immediateFn="function"==typeof setImmediate&&function(e){setImmediate(e)}||function(e){l(e,0)},r._unhandledRejectionFn=function(e){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)},e.Promise=r}}(window);var PermutiveUtils=function(){function e(){}return e.mergeNestedObjects=function(e,t){return[e,t].reduce(function(e,t){return Object.keys(t).forEach(function(n){e[n]=t[n]}),e},{})},e.merge=function(e,t){return this.extend(e,t)},e.extend=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];e=e||{};for(var r=1;r<arguments.length;r++)if(arguments[r])for(var i in arguments[r])e[i]=arguments[r][i];return e},e.swap=function(e){var t={};for(var n in e)t[e[n]]=n;return t},e.lens=function(e,t){var n,r=t.length;for(n=0;"object"==typeof e&&n<r;++n)e=e[t[n]];return e},e.deferredPromise=function(){var e,t;return{promise:new Promise(function(n,r){e=n,t=r}),reject:t,resolve:e}},e.ajax=function(e){return new Promise(function(t,n){var r={},i=e.dataType?e.dataType:"json",a=new XMLHttpRequest;if(e.contentType&&function(e,t){r[e.toLowerCase()]=[e,t]}("Content-Type",e.contentType),a.onload=function(){t("json"===i?this.responseText?JSON.parse(this.responseText):null:"text"===i?this.responseText:this.response)},a.onerror=function(){_internals.error("Failed AJAX request"),n(new TypeError("Network request failed"))},a.ontimeout=function(){_internals.error("AJAX request timed out"),n(new TypeError("Network request timed out"))},e.beforeSend&&e.beforeSend(a),a.open(e.type?e.type:"GET",e.url,!0),e.timeout&&(a.timeout=e.timeout),e.xhrFields)for(var s in e.xhrFields)a[s]=e.xhrFields[s];for(var o in r)r.hasOwnProperty(o)&&a.setRequestHeader(r[o][0],r[o][1]);a.send(e.data?e.data:null)})},e.poller=function(e,t,n){function r(e,t,s){if(!(a||i>=n)){var o=null;try{o=e()}catch(e){return}o?t():setTimeout(function(){i++,r(e,t,2*s)},s)}}void 0===n&&(n=30);var i=0,a=!1;return r(e,t,50),{cancel:function(){a=!0}}},e}(),permutive=window.permutive,PERMUTIVE_CONFIG={default:{apiHost:"api.permutive.com",cdnBaseUrl:"cdn.permutive.com",apiVersion:"v2.0",apiProtocol:"https",loggingEnabled:!1,requestTimeout:5e3,cookieName:"permutive-id",cookieExpiry:"10 Jan 2020 23:59:59 GMT",permutiveDataKey:"permutive-data",stateNamespace:"",sendClientErrors:!0,storeIP:!1,exposeInternals:!1,metricsSamplingPercentage:10},production:{},development:{apiProtocol:"http",loggingEnabled:!0,sendClientErrors:!1,exposeInternals:!0}};permutive.config.cookieDomain="."+extractDomain(window.location.hostname),Object.keys(PERMUTIVE_CONFIG.default).forEach(function(e){var t=e;void 0!==permutive.config[t]||(void 0!==PERMUTIVE_CONFIG[permutive.config.environment][t]?permutive.config[t]=PERMUTIVE_CONFIG[permutive.config.environment][t]:permutive.config[t]=PERMUTIVE_CONFIG.default[t])});var PermutiveMetricsNoOp=function(){function e(){}return e.prototype.track=function(e){},e.prototype.trackTimeSinceInit=function(e,t){},e.prototype.startTimer=function(e,t){},e.prototype.stopTimer=function(e,t){},e}(),PermutiveMetrics=function(){function e(e,t){void 0===t&&(t=5);var n=this;this.sdkInitTimestamp=e,this.pendingMetrics=[],this.pendingTimers={},permutive.ready(function(){window.setInterval(n.processPending.bind(n),1e3*t),window.addEventListener("beforeunload",function(){n.processPending.bind(n)},!1)}),this.track({name:"sdk_initialisation_start_time_seconds",value:e/1e3,labels:{}})}return e.prototype.track=function(e){this.pendingMetrics.push(e)},e.prototype.trackTimeSinceInit=function(e,t){var n=performance.now();this.track({name:e,value:(n-this.sdkInitTimestamp)/1e3,labels:t})},e.prototype.startTimer=function(e,t){var n=performance.now();this.pendingTimers[this.getUniqueKey(e,t)]={startTime:n,labels:t}},e.prototype.stopTimer=function(e,t){var n=this.pendingTimers[this.getUniqueKey(e,t)];if(n){var r=performance.now();this.track({name:e,value:(r-n.startTime)/1e3,labels:n.labels}),delete this.pendingTimers[e]}},e.prototype.processPending=function(){this.pendingMetrics.length>0&&(_internals.api.metrics({context:{environment:"web",events_count:_internals.state.eventsCache.all().length,segments_count:Object.keys(_internals.state.queryManager.queryStateMap).length},items:this.pendingMetrics}),this.pendingMetrics=[])},e.prototype.getUniqueKey=function(e,t){return e+":"+JSON.stringify(t)},e}(),PermutiveCore=function(){function e(e){this.listenForBlockers=!0,this.clientErrorsSent=0,this.isReady=!1,this.isRealtime=!1,this.isIdentityReady=!1,this.config=e}return e.prototype.getEndpointUrl=function(e){return this.config.apiProtocol+"://"+this.config.apiHost+"/"+this.config.apiVersion+e},e.prototype.utcNow=function(){var e=new Date;return new Date(e.toUTCString())},e.prototype.req=function(e){var t=this,n=e.url,r=e.method||"GET",i="";e.data&&e.jsonInParams?i={data:encodeURIComponent(JSON.stringify(e.data))}:e.data&&(i=JSON.stringify(e.data));var a=e.contentType?e.contentType:e.jsonInParams?"application/x-www-form-urlencoded":"application/json",s=function(e){e.setRequestHeader("X-API-Key",t.config.apiKey)};if(e.apiKeyInParams&&("GET"===r?(s=function(){},-1===n.indexOf("?")?n+="?k="+this.config.apiKey:n+="&k="+this.config.apiKey):"POST"===r&&(s=function(){},n+="?k="+this.config.apiKey)),e.useBeacon&&navigator.sendBeacon){var o=navigator.sendBeacon(n,i);if(e.complete&&e.complete("200"),o)return e.success&&e.success(i),Promise.resolve(i);var c="Failed to queue beacon";return e.error&&e.error(c),Promise.reject(c)}return PermutiveUtils.ajax({type:r,url:n,contentType:a,dataType:e.dataType?e.dataType:"json",data:i,timeout:this.config.timeout,beforeSend:s}).then(function(t){return e.success&&e.success(t),t},function(t){return e.error&&e.error(t),null}).then(function(t){return e.complete&&e.complete("200"),t})},e.prototype.log=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this.config.loggingEnabled&&window.console&&window.console.log&&(e.splice(0,0,"[Permutive]"),console.log.apply(console,e))},e.prototype.error=function(e){if(this.config.sendClientErrors){if(this.clientErrorsSent>3)return;this.clientErrorsSent+=1;var t={user_id:void 0!==_internals.state?_internals.state.userId:"",domain:window.location.hostname?window.location.hostname:"",url:window.location.href?window.location.href:"",referrer:document.referrer?document.referrer:"",user_agent:navigator.userAgent?navigator.userAgent:"",error_message:"",stack_trace:"",additional_details:""};e instanceof Error?(void 0!==e.message&&(t.error_message=e.message.toString()),void 0!==e.stack&&(t.stack_trace=e.stack.toString())):t.additional_details=e.toString(),this.req({url:this.getEndpointUrl("/internal/errors"),method:"POST",data:t,contentType:"text/plain",dataType:"text",apiKeyInParams:!0})}else window.console&&(window.console.error?window.console.error("[Permutive]",e):window.console.log&&window.console.log("[Permutive]",e))},e.prototype.createUser=function(e){e({user_id:_internals.randomUuid()})},e.prototype.applyQueue=function(){for(var e=[],t=[],n=[],r=[],i=[],a=0;a<permutive.q.length;a++)"identify"===(o=permutive.q[a]).functionName?e.push(o):"trigger"===o.functionName?t.push(o):"addon"===o.functionName?n.push(o):"track"===o.functionName?r.push(o):i.push(o);for(var s=e.concat(t).concat(n).concat(r).concat(i),a=0;a<s.length;a++){var o=s[a];o.functionName in permutive?permutive[o.functionName].apply(permutive,o.arguments):this.error('Function "permutive.'+o.functionName+'" does not exist.')}},e.prototype.setAsReady=function(){this.isReady=!0,_internals.metrics.trackTimeSinceInit("sdk_initialisation_task_duration_seconds",{}),_internals.messages.emit("permutive:ready")},e.prototype.setAsRealtime=function(){this.isRealtime=!0,_internals.metrics.trackTimeSinceInit("sdk_realtime_targeting_set_task_duration_seconds",{}),_internals.messages.emit("permutive:realtime")},e.prototype.setIdentityReady=function(){this.isIdentityReady=!0,_internals.messages.emit("permutive:identity:ready")},e.prototype.addBlocker=function(e){var t=this;_internals.blockers.push(e),this.log("<blockers> added blocker "+e),_internals.messages.on(e,function(){if(t.listenForBlockers){var n=_internals.blockers.indexOf(e);n>=0&&(_internals.blockers.splice(n,1),t.log("<blockers> removed blocker "+e)),0===_internals.blockers.length&&(t.listenForBlockers=!1,_internals.messages.emit("permutive:blockers:empty"),t.log("<blockers> complete"))}})},e.prototype.getNamespacedStorageKey=function(e){return""+permutive.config.stateNamespace+e},e.prototype.setCookie=function(e,t){if(!(t&&e&&this.config.cookieExpiry&&this.config.cookieDomain))return!1;var n=_internals.getNamespacedStorageKey(e);return document.cookie=encodeURIComponent(n)+"="+encodeURIComponent(t)+"; expires="+this.config.cookieExpiry+"; domain="+this.config.cookieDomain+"; path=/",!0},e.prototype.getCookie=function(e,t){void 0===t&&(t=!1);var n=t?e:_internals.getNamespacedStorageKey(e),r=new RegExp(encodeURIComponent(n)+"=([^;]+)").exec(document.cookie);return null!==r?decodeURIComponent(r[1]):null},e.prototype.deleteCookie=function(e){if(!e||!this.config.cookieDomain)return!1;var t=_internals.getNamespacedStorageKey(e);return document.cookie=encodeURIComponent(t)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; domain="+this.config.cookieDomain+"; path=/",!0},e.prototype.getExternalData=function(e){var t=_internals.getNamespacedStorageKey(e);return localStorage.getItem(t)},e.prototype.setExternalData=function(e,t){var n=_internals.getNamespacedStorageKey(e);localStorage.setItem(n,t)},e.prototype.removeExternalData=function(e){var t=_internals.getNamespacedStorageKey(e);localStorage.removeItem(t)},e.prototype.randomUuid=function(){var e=(new Date).getTime();return"undefined"!=typeof performance&&"function"==typeof performance.now&&(e+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:3&n|8).toString(16)})},e.prototype.arraysEqual=function(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(var n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0},e}(),PermutivePromises=function(){function e(){this.promises={}}return e.prototype.addPromise=function(e,t,n,r){var i=this;e in this.promises||(this.promises[e]={}),this.promises[e][t]=r,window.setTimeout(function(){i.resolvePromise(e,t)},n)},e.prototype.createPromise=function(e,t,n){this.addPromise(e,t,n,PermutiveUtils.deferredPromise())},e.prototype.getPromise=function(e,t){return PermutiveUtils.lens(this.promises,[e,t])},e.prototype.resolvePromise=function(e,t){var n=this.getPromise(e,t);return void 0!==n?(n.resolve(),n):void 0},e.prototype.getPromisesByCategory=function(e){var t=PermutiveUtils.lens(this.promises,[e])||{};return Object.keys(t).map(function(e){return t[e]})},e}(),_internals=new PermutiveCore(permutive.config),initialised=!1,handleConsent=function(e){return"object"==typeof e&&(localStorage.setItem("permutive-consent",JSON.stringify(e)),e.opt_in&&null!==e.token&&e.token.length>0)};permutive.consent=function(e){handleConsent(e)&&!initialised&&(initialiseSDK(),initialised=!0)};for(var i=0;i<permutive.q.length;i++){var funcCall=permutive.q[i];if("consent"===funcCall.functionName){var consentData=funcCall.arguments[0];handleConsent(consentData)&&!initialised&&(initialiseSDK(),initialised=!0)}}if(permutive.q=permutive.q.filter(function(e){return"consent"!==e.functionName}),!initialised){var cachedConsentData=JSON.parse(localStorage.getItem("permutive-consent")),optIn=cachedConsentData?cachedConsentData.opt_in:void 0;permutive.config.consentRequired&&optIn?initialiseSDK():permutive.config.consentRequired||!1===optIn||initialiseSDK()}}}();